import React, { useState, useEffect, useRef } from 'react';
import { 
  Plus, 
  Trash2, 
  Printer, 
  Edit3, 
  X,
  Check,
  Eye,
  Settings2,
  Palette,
  Tag,
  Image as ImageIcon,
  FileSpreadsheet,
  Download,
  AlertCircle,
  Sparkles,
  Key,
  Loader2,
  Save, // 新增儲存圖示
  RotateCcw // 重置圖示
} from 'lucide-react';

const App = () => {
  // --- 預設資料 ---
  const defaultTags = [
    { 
      id: '1001', 
      brand: 'CUPICHO', 
      name: '艾美黛黃金水果手工巧克力(5顆)',
      engName: 'Amedei Golden Fruit Handmade Chocolate (5pcs)',
      weight: '55g', 
      price: '580', 
      country: 'Italy', 
      itemNo: '2023001' 
    }
  ];

  // --- 狀態管理 (含初始化邏輯) ---
  const [tags, setTags] = useState(defaultTags);
  const [apiKey, setApiKey] = useState('');
  const [customLogo, setCustomLogo] = useState(null);
  
  // 載入狀態 (避免初次渲染覆蓋 LocalStorage)
  const [isLoaded, setIsLoaded] = useState(false);

  const [view, setView] = useState('list'); 
  const [editingId, setEditingId] = useState(null); 
  
  // UI 狀態
  const [deleteConfirmId, setDeleteConfirmId] = useState(null);
  const [csvImportData, setCsvImportData] = useState(null);
  const [errorMsg, setErrorMsg] = useState(null);
  
  // AI 相關狀態
  const [showKeyModal, setShowKeyModal] = useState(false);
  const [isBatchTranslating, setIsBatchTranslating] = useState(false);
  const [isSingleTranslating, setIsSingleTranslating] = useState(false);
  const [translateProgress, setTranslateProgress] = useState('');

  const fileInputRef = useRef(null);
  const csvInputRef = useRef(null);

  // --- 1. 初始化：從 LocalStorage 讀取資料 ---
  useEffect(() => {
    const loadData = () => {
      try {
        const savedTags = localStorage.getItem('cupicho_tags');
        const savedKey = localStorage.getItem('cupicho_api_key');
        const savedLogo = localStorage.getItem('cupicho_logo');

        if (savedTags) setTags(JSON.parse(savedTags));
        if (savedKey) setApiKey(savedKey);
        if (savedLogo) setCustomLogo(savedLogo);
      } catch (error) {
        console.error("讀取儲存資料失敗:", error);
      } finally {
        setIsLoaded(true);
      }
    };
    loadData();
  }, []);

  // --- 2. 自動存檔：當資料變動時寫入 LocalStorage ---
  useEffect(() => {
    if (isLoaded) {
      localStorage.setItem('cupicho_tags', JSON.stringify(tags));
    }
  }, [tags, isLoaded]);

  useEffect(() => {
    if (isLoaded) {
      localStorage.setItem('cupicho_api_key', apiKey);
    }
  }, [apiKey, isLoaded]);

  useEffect(() => {
    if (isLoaded && customLogo) {
      // 注意：LocalStorage 容量有限(約5MB)，大圖片可能會存失敗
      try {
        localStorage.setItem('cupicho_logo', customLogo);
      } catch (e) {
        console.warn("Logo 太大無法儲存，下次需重新上傳");
      }
    }
  }, [customLogo, isLoaded]);

  // --- 手動重置功能 ---
  const handleResetData = () => {
    if (confirm('確定要清除所有商品資料並恢復預設值嗎？(API Key 與 Logo 不會被清除)')) {
      setTags(defaultTags);
      alert('已重置為預設商品。');
    }
  };

  // --- 圖片處理 (轉為 Base64 以便存檔) ---
  const handleLogoUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    // 限制圖片大小 (例如 1MB)
    if (file.size > 1024 * 1024) {
      setErrorMsg("圖片檔案過大 (超過 1MB)，可能無法自動儲存。建議使用壓縮後的圖片。");
    }

    const reader = new FileReader();
    reader.onloadend = () => {
      setCustomLogo(reader.result); // 這是 Base64 字串
    };
    reader.readAsDataURL(file);
  };

  // --- Gemini API 呼叫 ---
  const callGeminiAPI = async (text) => {
    if (!apiKey) return null;
    
    const prompt = `Translate the following product name from Traditional Chinese to English for a high-end chocolate brand 'CupiCho'. 
    Style: Concise, Luxury, Premium, Professional.
    Rules: 
    1. Output English translation ONLY. No explanations.
    2. Maintain quantity/weight info (e.g., 5pcs, 100g).
    3. Proper nouns like 'Amedei' should be preserved.
    
    Input: "${text}"
    Output:`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });

      const data = await response.json();
      
      if (!response.ok || data.error) {
        console.warn("API Error:", data.error);
        return null;
      }
      
      return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
    } catch (error) {
      console.error("Network Error:", error);
      return null;
    }
  };

  // --- 慢速批次翻譯 ---
  const handleBatchTranslate = async () => {
    if (!apiKey) {
      setShowKeyModal(true);
      return;
    }

    setIsBatchTranslating(true);
    let updatedTags = [...tags];
    
    const queueIndices = updatedTags.map((tag, index) => {
      const hasChinese = /[\u4e00-\u9fa5]/.test(tag.engName);
      const isEmpty = !tag.engName || tag.engName.trim() === '';
      return (hasChinese || isEmpty) ? index : -1;
    }).filter(index => index !== -1);

    if (queueIndices.length === 0) {
      alert("目前沒有需要翻譯的項目");
      setIsBatchTranslating(false);
      return;
    }

    let successCount = 0;

    for (let i = 0; i < queueIndices.length; i++) {
      const index = queueIndices[i];
      const tag = updatedTags[index];
      
      setTranslateProgress(`翻譯中 (${i + 1}/${queueIndices.length}): ${tag.name}...`);
      
      const translatedText = await callGeminiAPI(tag.name);
      
      if (translatedText) {
        updatedTags[index] = { ...tag, engName: translatedText };
        successCount++;
        setTags([...updatedTags]); 
      }

      // 強制冷卻 5 秒
      if (i < queueIndices.length - 1) {
        let countdown = 5;
        while (countdown > 0) {
          setTranslateProgress(`冷卻中... ${countdown}s`);
          await new Promise(r => setTimeout(r, 1000));
          countdown--;
        }
      }
    }

    setIsBatchTranslating(false);
    setTranslateProgress('');
    alert(`完成！成功翻譯 ${successCount} 筆。`);
  };

  // --- 基本操作 ---
  const addTag = () => {
    const randomNo = Math.floor(100000 + Math.random() * 900000).toString();
    const newTag = { 
      id: Date.now().toString(), 
      brand: 'CUPICHO', 
      name: '新產品名稱', 
      engName: '',
      weight: '100g', 
      price: '200', 
      country: 'Taiwan', 
      itemNo: randomNo 
    };
    setTags([newTag, ...tags]);
    setEditingId(newTag.id);
  };

  const updateTag = (id, field, value) => {
    setTags(prevTags => prevTags.map(t => t.id === id ? { ...t, [field]: value } : t));
  };

  const deleteTag = (id) => {
    setTags(tags.filter(t => t.id !== id));
    setDeleteConfirmId(null);
    if (editingId === id) setEditingId(null);
  };

  const handlePrint = () => {
    setView('preview');
    setTimeout(() => { window.print(); }, 800);
  };

  // --- CSV 匯入 ---
  const handleCSVUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const rows = text.split(/\r\n|\n/);
        
        if (rows.length < 2) { setErrorMsg('CSV 內容太少'); return; }

        const headerRow = rows[0].toUpperCase();
        const headers = headerRow.split(',').map(h => h.trim());

        // 欄位對映
        const fieldKeywords = {
            itemNo: ['ITEM NO', 'NO.', 'ITEM', '品號', '編號', 'ID'],
            brand: ['BRAND', '品牌'],
            name: ['NAME (CHI)', 'CHINESE', '品名', '中文名', 'NAME'],
            engName: ['NAME (ENG)', 'ENGLISH', '英文名', 'ENG'],
            price: ['PRICE', '價格', '售價', '$'],
            weight: ['WEIGHT', '重量', '規格'],
            country: ['COUNTRY', '國家', '產地', 'ORIGIN']
        };

        const getIndex = (key) => headers.findIndex(h => fieldKeywords[key].some(k => h.includes(k)));
        
        // 建立索引表
        const indices = Object.keys(fieldKeywords).reduce((acc, key) => {
            acc[key] = getIndex(key);
            return acc;
        }, {});

        const isSmartMode = indices.name !== -1 || indices.price !== -1;
        const newTags = [];
        
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i].trim();
          if (!row) continue;
          
          // 處理 CSV 中可能含有逗號的情況 (簡單版：只處理沒引號的)
          const cols = row.split(',');
          const getData = (fieldKey, fallbackIndex) => {
              const idx = isSmartMode ? indices[fieldKey] : fallbackIndex;
              if (idx !== -1 && cols[idx] !== undefined) return cols[idx].trim();
              return '';
          };

          const rawName = getData('name', 2) || '未命名商品';
          
          if (cols.length >= 2) {
             newTags.push({
               id: Date.now().toString() + i + Math.random(),
               itemNo: getData('itemNo', 0) || '000000',
               brand: getData('brand', 1) || 'CUPICHO',
               name: rawName,
               engName: getData('engName', 3) || '', 
               price: getData('price', 4) || '0',
               weight: getData('weight', 5) || '',
               country: getData('country', 6) || ''
             });
          }
        }

        if (newTags.length > 0) {
          setCsvImportData(newTags);
        } else {
          setErrorMsg('CSV 解析失敗');
        }
      } catch (err) {
        console.error(err);
        setErrorMsg('讀取檔案錯誤');
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  };

  const confirmImport = (mode) => {
    if (!csvImportData) return;
    if (mode === 'overwrite') {
      setTags(csvImportData);
    } else {
      setTags([...csvImportData, ...tags]);
    }
    setCsvImportData(null);
  };

  const downloadTemplate = () => {
    const headers = "ITEM NO.,BRAND,NAME (CHI),NAME (ENG),PRICE $,WEIGHT,COUNTRY\n";
    const sample = "2023001,CUPICHO,艾美黛黃金水果手工巧克力(5顆),,580,55g,Italy\n";
    const blob = new Blob(["\ufeff" + headers + sample], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "cupicho_template.csv";
    link.click();
  };

  const currentEditingTag = tags.find(t => t.id === editingId);

  // --- 核心組件：CUPICHO 標籤 ---
  const PriceTag = ({ tag }) => {
    return (
      <div className="cupicho-tag relative flex overflow-hidden box-border"
           style={{ 
             width: '80mm',      
             height: '50mm',     
             backgroundColor: '#2B130F',
             color: '#E1C284',
             pageBreakInside: 'avoid',
             fontFamily: '"WenYue GuDianMingChaoTi", "Noto Serif TC", serif'
           }}>
        
        <div className="w-[35%] h-full flex flex-col pl-3 py-3 relative z-10">
            <div className="h-[30%] flex items-start -ml-1">
              {customLogo ? (
                <img src={customLogo} alt="Brand Logo" className="w-[90%] h-full object-contain object-left-top"/>
              ) : (
                <svg viewBox="0 0 100 45" className="w-[90%] h-auto">
                  <ellipse cx="50" cy="22.5" rx="48" ry="20" fill="none" stroke="#E1C284" strokeWidth="1.5" />
                  <ellipse cx="50" cy="22.5" rx="45" ry="17" fill="none" stroke="#E1C284" strokeWidth="0.5" opacity="0.5"/>
                  <text x="50" y="24" textAnchor="middle" fill="#E1C284" fontSize="16" fontFamily="serif" fontWeight="bold" letterSpacing="0.5">CupiCho</text>
                  <text x="50" y="36" textAnchor="middle" fill="#E1C284" fontSize="7" fontFamily="sans-serif" letterSpacing="1">丘比巧</text>
                </svg>
              )}
            </div>

            <div className="flex-1 flex items-start pt-2 pl-1">
               <div className="flex items-baseline" style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>
                  <span style={{ fontSize: '14pt', marginRight: '3px' }}>$</span>
                  <span style={{ fontSize: '20pt', lineHeight: '1' }}>{tag.price}</span>
               </div>
            </div>

            <div className="mt-auto mb-1 w-full pl-1">
               <div style={{ 
                 fontFamily: '"Libre Barcode 39", cursive', 
                 fontSize: '40px', 
                 color: '#E1C284', 
                 lineHeight: 0.7, 
                 whiteSpace: 'nowrap', 
                 marginLeft: '-10px', 
                 transform: 'scaleX(0.6)', 
                 transformOrigin: 'left bottom', 
                 marginBottom: '2px' 
               }}>
                 {tag.itemNo ? `*${tag.itemNo}*` : ''}
               </div>
               <div className="text-[9px] font-serif tracking-widest text-[#E1C284] leading-none">
                 {tag.itemNo}
               </div>
            </div>
        </div>

        <div className="w-[65%] h-full flex flex-col pr-4 py-3 pl-1 relative z-10">
            <div style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif', fontSize: '18pt', lineHeight: '1.2', marginBottom: '4px' }}>
              {tag.brand}
            </div>
            <div style={{ fontFamily: '"Kinuta KinutaMincho StdN R", "Shippori Mincho", serif', fontSize: '14pt', lineHeight: '1.3', marginBottom: '2px' }}>
              {tag.name}
            </div>
            <div style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif', fontSize: '6pt', lineHeight: '1.2', textTransform: 'uppercase', letterSpacing: '0.5px', opacity: 0.9 }}>
              {tag.engName}
            </div>
            <div className="flex gap-5 absolute bottom-3 right-4" style={{ fontSize: '10pt' }}>
              <span style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>{tag.weight}</span>
              <span style={{ fontFamily: '"Kinuta KinutaMincho StdN R", serif' }}>{tag.country}</span>
            </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-[#1a0e0b] flex flex-col max-w-md mx-auto relative shadow-2xl">
      
      <input type="file" ref={fileInputRef} onChange={handleLogoUpload} accept="image/*" className="hidden" />
      <input type="file" ref={csvInputRef} onChange={handleCSVUpload} accept=".csv" className="hidden" />

      <style>
        {`@import url('https://fonts.googleapis.com/css2?family=Libre+Barcode+39&family=Noto+Serif+TC:wght@400;700&family=Shippori+Mincho&display=swap');`}
      </style>

      {/* 頂部標題 */}
      <header className="bg-[#2B130F] px-4 py-3 flex items-center justify-between border-b border-[#E1C284]/20 sticky top-0 z-20 shadow-lg">
        <div className="flex items-center gap-2">
          <div className="text-[#E1C284]"><Palette size={20} /></div>
          <div>
            <h1 className="font-bold text-[#E1C284] text-base tracking-widest">CUPICHO</h1>
            <p className="text-[#E1C284]/60 text-[10px] flex items-center gap-1">
              <Save size={10} className="animate-pulse"/> Auto-Save Enabled
            </p>
          </div>
        </div>
        <div className="flex gap-2">
          <button onClick={() => setShowKeyModal(true)} className={`p-2 rounded-lg border ${apiKey ? 'bg-[#E1C284]/20 border-[#E1C284] text-[#E1C284]' : 'bg-[#2B130F] border-[#E1C284]/30 text-[#E1C284]/50'}`} title="API Key">
            <Key size={18} />
          </button>
          
          <button onClick={() => csvInputRef.current.click()} className="bg-[#2B130F] border border-[#E1C284]/50 text-[#E1C284] p-2 rounded-lg" title="匯入 CSV">
            <FileSpreadsheet size={18} />
          </button>
          <button onClick={() => fileInputRef.current.click()} className="bg-[#2B130F] border border-[#E1C284]/50 text-[#E1C284] p-2 rounded-lg" title="更換 Logo">
            <ImageIcon size={18} />
          </button>
          <button onClick={handlePrint} className="bg-[#E1C284] text-[#2B130F] p-2 rounded-lg font-bold flex items-center gap-1">
            <Printer size={18} />
            <span className="text-xs">列印</span>
          </button>
        </div>
      </header>

      {/* 主內容區 */}
      <main className="flex-1 overflow-y-auto p-4 pb-28">
        {view === 'list' ? (
          <div className="space-y-4">
             <div className="flex justify-between items-center px-1">
              <span className="text-[10px] font-bold text-[#E1C284]/60 uppercase tracking-widest">Product List ({tags.length})</span>
              
              <div className="flex gap-2">
                <button onClick={handleResetData} className="text-[#E1C284]/30 hover:text-[#E1C284] p-1" title="重置清單">
                  <RotateCcw size={14} />
                </button>
                <button 
                  onClick={handleBatchTranslate}
                  disabled={isBatchTranslating}
                  className="flex items-center gap-1 bg-gradient-to-r from-purple-900 to-[#2B130F] border border-[#E1C284]/50 text-[#E1C284] px-3 py-1.5 rounded-full text-xs font-bold shadow-lg active:scale-95 transition-all"
                >
                  {isBatchTranslating ? <Loader2 size={12} className="animate-spin"/> : <Sparkles size={12} />}
                  {isBatchTranslating ? 'Translating...' : 'AI Translate'}
                </button>
              </div>
            </div>

            {isBatchTranslating && (
              <div className="bg-[#E1C284]/10 rounded-lg p-3 border border-[#E1C284]/20 flex flex-col gap-2">
                <div className="flex justify-between items-center text-xs text-[#E1C284]">
                   <span className="flex items-center gap-1"><Loader2 size={10} className="animate-spin"/> AI Processing</span>
                   <span>Auto-Cooldowned</span>
                </div>
                <div className="bg-[#2B130F] rounded-full h-1.5 overflow-hidden">
                  <div className="bg-[#E1C284] h-full animate-pulse w-full"></div>
                </div>
                <p className="text-[10px] text-[#E1C284]/80 text-center font-mono">{translateProgress}</p>
              </div>
            )}

            {tags.length === 0 ? (
              <div className="py-20 text-center flex flex-col items-center opacity-40">
                <Tag size={48} className="text-[#E1C284] mb-2" />
                <p className="text-sm font-bold text-[#E1C284]">目前清單為空</p>
                <button onClick={addTag} className="text-xs text-[#E1C284] underline mt-2">新增一個測試商品</button>
              </div>
            ) : (
              tags.map(tag => (
                <div key={tag.id} className="bg-[#3e2b27] p-4 rounded-sm border border-[#E1C284]/30 shadow-md flex items-center justify-between active:scale-[0.98]" onClick={() => setEditingId(tag.id)}>
                  <div className="flex-1 min-w-0 pr-3">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-[10px] font-mono text-[#E1C284]/70">#{tag.itemNo}</span>
                    </div>
                    <p className="font-bold text-[#E1C284] truncate text-lg font-serif">{tag.name}</p>
                    {(!tag.engName) ? (
                      <p className="text-[10px] text-red-400/80 italic flex items-center gap-1">
                        <AlertCircle size={10}/> Missing English
                      </p>
                    ) : (
                      <p className="text-[10px] text-[#E1C284]/80 truncate uppercase">{tag.engName}</p>
                    )}
                  </div>
                  <div className="flex flex-col items-end gap-1">
                     <span className="text-xl font-serif text-[#E1C284]">${tag.price}</span>
                     <button className="p-2 text-[#E1C284]/50 hover:text-red-400" onClick={(e) => { e.stopPropagation(); setDeleteConfirmId(tag.id); }}>
                      <Trash2 size={16} />
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        ) : (
          <div className="flex flex-col items-center space-y-6">
            <div className="w-full flex justify-between items-center px-2 bg-[#E1C284]/10 p-2 rounded-lg border border-[#E1C284]/20">
              <span className="text-[10px] font-bold text-[#E1C284] uppercase flex items-center gap-1"><Eye size={12}/> Preview</span>
              <span className="text-[10px] text-[#E1C284] font-bold">80x50mm</span>
            </div>
            <div className="w-full flex flex-col items-center gap-6">
              {tags.map(tag => (
                <div key={tag.id} className="shadow-2xl shadow-black/50 origin-top">
                  <PriceTag tag={tag} />
                </div>
              ))}
            </div>
          </div>
        )}
      </main>

      {/* 底部選單 */}
      <nav className="bg-[#2B130F] border-t border-[#E1C284]/20 px-6 py-2 flex justify-around items-center fixed bottom-0 left-0 right-0 max-w-md mx-auto z-30 shadow-2xl pb-safe">
        <button onClick={() => setView('list')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'list' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}>
          <Settings2 size={24} strokeWidth={1.5} />
          <span className="text-[10px] font-serif tracking-widest">LIST</span>
        </button>
        <div className="w-12"></div>
        <button onClick={() => setView('preview')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'preview' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}>
          <Eye size={24} strokeWidth={1.5} />
          <span className="text-[10px] font-serif tracking-widest">PREVIEW</span>
        </button>
      </nav>

      {/* 浮動新增按鈕 */}
      {view === 'list' && !editingId && !deleteConfirmId && !csvImportData && !showKeyModal && (
        <button onClick={addTag} className="fixed bottom-8 left-1/2 -translate-x-1/2 w-16 h-16 bg-[#E1C284] text-[#2B130F] rounded-full shadow-[0_0_20px_rgba(225,194,132,0.4)] flex items-center justify-center active:scale-95 transition-transform z-40 border-4 border-[#2B130F]">
          <Plus size={32} strokeWidth={2} />
        </button>
      )}

      {/* API Key Modal */}
      {showKeyModal && (
        <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-6 backdrop-blur-sm">
           <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl relative">
             <button onClick={() => setShowKeyModal(false)} className="absolute top-2 right-2 text-[#E1C284]/50"><X size={16}/></button>
             <div className="flex flex-col items-center mb-4">
                <Sparkles className="text-[#E1C284] mb-2" size={32} />
                <h3 className="font-serif text-lg text-[#E1C284] text-center">AI Settings</h3>
             </div>
             <p className="text-[#E1C284]/70 text-xs mb-4 text-center">
               請輸入您的 Google Gemini API Key 以啟用智慧翻譯功能。
               (Key 會自動儲存在此瀏覽器中，下次不需輸入)
             </p>
             <input 
               type="password" 
               placeholder="Paste API Key here..."
               value={apiKey}
               onChange={(e) => setApiKey(e.target.value)}
               className="w-full px-3 py-2 bg-[#1a0e0b] text-[#E1C284] border border-[#E1C284]/30 rounded-sm mb-4 outline-none text-sm"
             />
             <button onClick={() => setShowKeyModal(false)} className="w-full py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold text-sm">
               Save & Close
             </button>
           </div>
        </div>
      )}

      {/* CSV Import Modal */}
      {csvImportData && (
        <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6 backdrop-blur-sm">
          <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
            <h3 className="font-serif text-lg text-[#E1C284] text-center mb-4">CSV Import</h3>
            <p className="text-[#E1C284]/80 text-sm text-center font-serif mb-6">成功讀取 {csvImportData.length} 筆資料。</p>
            <div className="flex flex-col gap-3">
              <button onClick={() => confirmImport('overwrite')} className="w-full py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold text-sm">覆蓋</button>
              <button onClick={() => confirmImport('append')} className="w-full py-3 bg-[#3e2b27] text-[#E1C284] rounded-sm font-bold text-sm border border-[#E1C284]/30">追加</button>
            </div>
          </div>
        </div>
      )}
      
      {/* 編輯抽屜 */}
      {editingId && currentEditingTag && (
        <div className="fixed inset-0 bg-black/80 z-50 flex flex-col justify-end backdrop-blur-[2px]">
          <div className="bg-[#2B130F] border-t border-[#E1C284]/30 rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto animate-in slide-in-from-bottom duration-300 shadow-2xl">
             <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-serif text-[#E1C284] flex items-center gap-2 italic">Edit Product</h3>
              <button onClick={() => setEditingId(null)} className="p-2 bg-[#E1C284]/10 rounded-full text-[#E1C284]"><X size={20}/></button>
            </div>

            <div className="space-y-4">
              <div className="grid grid-cols-3 gap-3">
                 <div className="col-span-2 space-y-1">
                  <label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">ITEM NO.</label>
                  <input type="text" value={currentEditingTag.itemNo} onChange={(e) => updateTag(editingId, 'itemNo', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-mono text-sm border border-[#E1C284]/20" />
                </div>
                <div className="col-span-1 space-y-1">
                  <label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">COUNTRY</label>
                  <input type="text" value={currentEditingTag.country} onChange={(e) => updateTag(editingId, 'country', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none text-sm text-center border border-[#E1C284]/20 font-serif" />
                </div>
              </div>

              <div className="space-y-1">
                <label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">BRAND</label>
                <input type="text" value={currentEditingTag.brand} onChange={(e) => updateTag(editingId, 'brand', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-sm border border-[#E1C284]/20" />
              </div>

              <div className="space-y-1">
                <label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">NAME (CHI)</label>
                <input type="text" value={currentEditingTag.name} onChange={(e) => updateTag(editingId, 'name', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-lg border border-[#E1C284]/20" />
              </div>

               {/* 英文品名 + AI 翻譯按鈕 */}
               <div className="flex gap-2 items-end">
                  <div className="flex-1 space-y-1">
                    <label className="text-[10px] font-serif text-[#E1C284]/60 ml-1 flex justify-between">
                      <span>NAME (ENG)</span>
                      {isSingleTranslating && <span className="text-[#E1C284] animate-pulse italic">Translating...</span>}
                    </label>
                    <input 
                      type="text" 
                      value={currentEditingTag.engName} 
                      onChange={(e) => updateTag(editingId, 'engName', e.target.value)} 
                      className="w-full px-3 py-2 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-xs border border-[#E1C284]/20 uppercase" 
                      placeholder="English Name"
                    />
                  </div>
                  <button 
                    onClick={async () => {
                      if(!apiKey) { 
                        setShowKeyModal(true); 
                        return; 
                      }
                      setIsSingleTranslating(true);
                      const res = await callGeminiAPI(currentEditingTag.name);
                      if(res) updateTag(editingId, 'engName', res);
                      setIsSingleTranslating(false);
                    }} 
                    disabled={isSingleTranslating}
                    className="mb-[1px] h-[34px] px-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold text-[10px] flex items-center gap-1 shadow-md active:scale-95 transition-all whitespace-nowrap"
                  >
                    {isSingleTranslating ? <Loader2 size={12} className="animate-spin"/> : <Sparkles size={12}/>}
                    AI 翻譯
                  </button>
               </div>

              <div className="grid grid-cols-2 gap-3">
                <div className="space-y-1">
                  <label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">PRICE $</label>
                  <input type="number" value={currentEditingTag.price} onChange={(e) => updateTag(editingId, 'price', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-2xl border border-[#E1C284]/20" />
                </div>
                <div className="space-y-1">
                  <label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">WEIGHT</label>
                  <input type="text" value={currentEditingTag.weight} onChange={(e) => updateTag(editingId, 'weight', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-sm border border-[#E1C284]/20" />
                </div>
              </div>

              <div className="py-4 flex justify-center bg-[#1a0e0b] rounded-sm overflow-hidden mt-4 border border-[#E1C284]/10">
                 <div className="transform scale-90 origin-center shadow-lg">
                   <PriceTag tag={currentEditingTag} />
                 </div>
              </div>
              <button onClick={() => setEditingId(null)} className="w-full py-4 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold flex items-center justify-center gap-2 shadow-lg active:scale-[0.98] transition-all font-serif tracking-widest">
                <Check size={20} /> SAVE
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 刪除確認 */}
      {deleteConfirmId && (
        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm">
          <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
            <h3 className="font-serif text-lg text-[#E1C284] mb-2 text-center">Delete Item?</h3>
            <div className="flex gap-3 mt-6">
              <button onClick={() => setDeleteConfirmId(null)} className="flex-1 py-3 bg-[#1a0e0b] text-[#E1C284]/60 rounded-sm font-serif text-sm border border-[#E1C284]/20">Cancel</button>
              <button onClick={() => deleteTag(deleteConfirmId)} className="flex-1 py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-serif font-bold text-sm">Delete</button>
            </div>
          </div>
        </div>
      )}

      {/* Error Msg */}
      {errorMsg && (
        <div className="fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-6 backdrop-blur-sm">
          <div className="bg-[#2B130F] border border-red-500 rounded-sm p-6 w-full max-w-xs shadow-2xl">
             <div className="flex flex-col items-center">
               <AlertCircle className="text-red-500 mb-2" size={32} />
               <p className="text-red-500 text-center font-bold mb-4">{errorMsg}</p>
               <button onClick={() => setErrorMsg(null)} className="w-full py-2 bg-red-500/20 text-red-500 border border-red-500 rounded-sm">Close</button>
             </div>
          </div>
        </div>
      )}

      <style>
        {`
          @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            header, nav, button, .z-40, .z-50, .z-60, .z-70, .z-80, .z-90 { display: none !important; }
            main { padding: 0 !important; overflow: visible !important; }
            main > div > div:first-child { display: none !important; }
            main > div:last-child > div.w-full { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 5mm !important; width: 100% !important; }
            .cupicho-tag { border: 1px solid #1a0e0b !important; break-inside: avoid !important; margin: 0 auto !important; background-color: #2B130F !important; color: #E1C284 !important; }
          }
        `}
      </style>
    </div>
  );
};

export default App;
