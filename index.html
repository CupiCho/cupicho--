<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CupiCho Price Tag System</title>
    
    <!-- 1. 載入 Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 核心 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. 載入 Babel (讓瀏覽器看得懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 載入字型 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Barcode+39&family=Noto+Serif+TC:wght@400;700&family=Shippori+Mincho&display=swap');
        
        /* 補強列印樣式 */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
            .print-container { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; 
                gap: 5mm !important; 
                width: 100% !important; 
            }
            .cupicho-tag { 
                border: 1px solid #1a0e0b !important; 
                break-inside: avoid !important; 
                margin: 0 auto !important; 
                background-color: #2B130F !important; 
                color: #E1C284 !important; 
            }
        }
    </style>
</head>
<body class="bg-[#1a0e0b] min-h-screen">
    <div id="root"></div>

    <!-- 5. React 程式碼邏輯 -->
    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef } = React;
        
        // 修正後的圖示組件 (Lucide Icons)
        const Icon = ({ name, size = 18, className }) => {
            const icons = {
                Plus: <path d="M5 12h14M12 5v14" />,
                Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
                Printer: <><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>,
                Edit3: <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                Check: <polyline points="20 6 9 17 4 12" />,
                Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></>,
                Settings2: <><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /><circle cx="1" cy="1" r="1" /></>,
                Palette: <circle cx="13.5" cy="6.5" r=".5" fill="currentColor" />,
                Tag: <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z" />,
                // 修復的圖示
                Image: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></>,
                FileSpreadsheet: <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></>,
                Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
                AlertCircle: <><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></>,
                Sparkles: <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M20 3v4" /><path d="M22 5h-4" /><path d="M4 17v2" /><path d="M5 18H3" /></>,
                Key: <><circle cx="7.5" cy="15.5" r="5.5" /><path d="m21 2-9.6 9.6" /><path d="m15.5 7.5 3 3L22 7l-3-3" /></>,
                Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
                Save: <><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" /><path d="M17 21v-8H7v8" /><path d="M7 3v5h8" /></>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" />
            };
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const App = () => {
            const defaultTags = [
                { 
                id: '1001', 
                brand: 'CUPICHO', 
                name: '艾美黛黃金水果手工巧克力(5顆)',
                engName: 'Amedei Golden Fruit Handmade Chocolate (5pcs)',
                weight: '55g', 
                price: '580', 
                country: 'Italy', 
                itemNo: '2023001' 
                }
            ];

            const [tags, setTags] = useState(defaultTags);
            const [apiKey, setApiKey] = useState('');
            const [customLogo, setCustomLogo] = useState(null);
            const [isLoaded, setIsLoaded] = useState(false);
            const [view, setView] = useState('list'); 
            const [editingId, setEditingId] = useState(null); 
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const [csvImportData, setCsvImportData] = useState(null);
            const [errorMsg, setErrorMsg] = useState(null);
            const [showKeyModal, setShowKeyModal] = useState(false);
            const [isBatchTranslating, setIsBatchTranslating] = useState(false);
            const [isSingleTranslating, setIsSingleTranslating] = useState(false);
            const [translateProgress, setTranslateProgress] = useState('');

            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);

            useEffect(() => {
                const loadData = () => {
                try {
                    const savedTags = localStorage.getItem('cupicho_tags');
                    const savedKey = localStorage.getItem('cupicho_api_key');
                    const savedLogo = localStorage.getItem('cupicho_logo');

                    if (savedTags) setTags(JSON.parse(savedTags));
                    if (savedKey) setApiKey(savedKey);
                    if (savedLogo) setCustomLogo(savedLogo);
                } catch (error) {
                    console.error("讀取儲存資料失敗:", error);
                } finally {
                    setIsLoaded(true);
                }
                };
                loadData();
            }, []);

            useEffect(() => {
                if (isLoaded) localStorage.setItem('cupicho_tags', JSON.stringify(tags));
            }, [tags, isLoaded]);

            useEffect(() => {
                if (isLoaded) localStorage.setItem('cupicho_api_key', apiKey);
            }, [apiKey, isLoaded]);

            useEffect(() => {
                if (isLoaded && customLogo) {
                try {
                    localStorage.setItem('cupicho_logo', customLogo);
                } catch (e) {
                    console.warn("Logo 太大無法儲存");
                }
                }
            }, [customLogo, isLoaded]);

            const handleResetData = () => {
                if (confirm('確定要清除所有商品資料並恢復預設值嗎？')) {
                setTags(defaultTags);
                }
            };

            const handleLogoUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (file.size > 1024 * 1024) {
                    setErrorMsg("圖片檔案過大 (超過 1MB)，建議壓縮後再上傳。");
                }
                const reader = new FileReader();
                reader.onloadend = () => setCustomLogo(reader.result);
                reader.readAsDataURL(file);
            };

            const callGeminiAPI = async (text, retryCount = 0) => {
                if (!apiKey) return null;
                const prompt = `Translate to English for high-end chocolate brand 'CupiCho'. Style: Premium. Keep quantity info. Input: "${text}" Output:`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (response.status === 429) throw new Error('429');
                    const data = await response.json();
                    if (data.error) {
                        if (data.error.code === 429) throw new Error('429');
                        return null;
                    }
                    return data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
                } catch (error) {
                    if (error.message === '429' && retryCount < 3) {
                        const waitTime = 10000 * Math.pow(2, retryCount);
                        setTranslateProgress(`Rate limit. Waiting ${waitTime/1000}s...`);
                        await new Promise(r => setTimeout(r, waitTime));
                        return callGeminiAPI(text, retryCount + 1);
                    }
                    return null;
                }
            };

            const handleBatchTranslate = async () => {
                if (!apiKey) { setShowKeyModal(true); return; }
                setIsBatchTranslating(true);
                let updatedTags = [...tags];
                const queueIndices = updatedTags.map((tag, index) => {
                    const hasChinese = /[\u4e00-\u9fa5]/.test(tag.engName);
                    const isEmpty = !tag.engName || tag.engName.trim() === '';
                    return (hasChinese || isEmpty) ? index : -1;
                }).filter(index => index !== -1);

                if (queueIndices.length === 0) {
                    alert("目前沒有需要翻譯的項目");
                    setIsBatchTranslating(false);
                    return;
                }

                let successCount = 0;
                for (let i = 0; i < queueIndices.length; i++) {
                    const index = queueIndices[i];
                    const tag = updatedTags[index];
                    setTranslateProgress(`翻譯中 (${i + 1}/${queueIndices.length}): ${tag.name}...`);
                    const translatedText = await callGeminiAPI(tag.name);
                    if (translatedText) {
                        updatedTags[index] = { ...tag, engName: translatedText };
                        successCount++;
                        setTags([...updatedTags]);
                    }
                    if (i < queueIndices.length - 1) {
                        setTranslateProgress(`冷卻中... 避免錯誤`);
                        await new Promise(r => setTimeout(r, 5000));
                    }
                }
                setIsBatchTranslating(false);
                setTranslateProgress('');
                alert(`完成！成功翻譯 ${successCount} 筆。`);
            };

            const addTag = () => {
                const randomNo = Math.floor(100000 + Math.random() * 900000).toString();
                setTags([...tags, { 
                    id: Date.now().toString(), brand: 'CUPICHO', name: '新產品名稱', engName: '', 
                    weight: '100g', price: '200', country: 'Taiwan', itemNo: randomNo 
                }]);
            };

            const updateTag = (id, field, value) => {
                setTags(tags.map(t => t.id === id ? { ...t, [field]: value } : t));
            };

            const deleteTag = (id) => {
                setTags(tags.filter(t => t.id !== id));
                setDeleteConfirmId(null);
                if (editingId === id) setEditingId(null);
            };

            const handleCSVUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = text.split(/\r\n|\n/);
                        if (rows.length < 2) { setErrorMsg('CSV 內容太少'); return; }
                        
                        const headerRow = rows[0].toUpperCase();
                        const headers = headerRow.split(',').map(h => h.trim());
                        
                        const fieldKeywords = {
                            itemNo: ['ITEM NO', 'NO.', '品號'], brand: ['BRAND', '品牌'],
                            name: ['NAME (CHI)', '品名', '中文'], engName: ['NAME (ENG)', '英文'],
                            price: ['PRICE', '價格', '$'], weight: ['WEIGHT', '重量'], country: ['COUNTRY', '國家']
                        };
                        
                        const getIndex = (key) => headers.findIndex(h => fieldKeywords[key].some(k => h.includes(k)));
                        const indices = {
                            itemNo: getIndex('itemNo'), brand: getIndex('brand'), name: getIndex('name'),
                            engName: getIndex('engName'), price: getIndex('price'), weight: getIndex('weight'), country: getIndex('country')
                        };
                        
                        const isSmartMode = indices.name !== -1 || indices.price !== -1;
                        const newTags = [];
                        
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i].trim();
                            if (!row) continue;
                            const cols = row.split(',');
                            const getData = (key, fallback) => {
                                const idx = isSmartMode ? indices[key] : fallback;
                                return (idx !== -1 && cols[idx]) ? cols[idx].trim() : '';
                            };
                            
                            const rawName = getData('name', 2) || '未命名';
                            if (cols.length >= 2) {
                                newTags.push({
                                    id: Date.now() + i + Math.random(),
                                    itemNo: getData('itemNo', 0) || '000000',
                                    brand: getData('brand', 1) || 'CUPICHO',
                                    name: rawName,
                                    engName: getData('engName', 3) || '',
                                    price: getData('price', 4) || '0',
                                    weight: getData('weight', 5) || '',
                                    country: getData('country', 6) || ''
                                });
                            }
                        }
                        if (newTags.length > 0) setCsvImportData(newTags);
                        else setErrorMsg('CSV 解析失敗');
                    } catch (e) { setErrorMsg('讀取錯誤'); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const confirmImport = (mode) => {
                if (mode === 'overwrite') setTags(csvImportData);
                else setTags([...csvImportData, ...tags]);
                setCsvImportData(null);
            };

            const downloadTemplate = () => {
                const csvContent = "\ufeffITEM NO.,BRAND,NAME (CHI),NAME (ENG),PRICE $,WEIGHT,COUNTRY\n2023001,CUPICHO,範例巧克力,,580,55g,Italy\n";
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                link.download = "cupicho_template.csv";
                link.click();
            };

            // 標籤組件
            const PriceTag = ({ tag }) => (
                <div className="cupicho-tag relative flex overflow-hidden box-border" style={{ width: '80mm', height: '50mm', backgroundColor: '#2B130F', color: '#E1C284', fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>
                    <div className="w-[35%] h-full flex flex-col pl-3 py-3 relative z-10">
                        <div className="h-[30%] flex items-start -ml-1">
                            {customLogo ? 
                                <img src={customLogo} className="w-[90%] h-full object-contain object-left-top"/> : 
                                <svg viewBox="0 0 100 45" className="w-[90%] h-auto">
                                    <ellipse cx="50" cy="22.5" rx="48" ry="20" fill="none" stroke="#E1C284" strokeWidth="1.5" />
                                    <ellipse cx="50" cy="22.5" rx="45" ry="17" fill="none" stroke="#E1C284" strokeWidth="0.5" opacity="0.5"/>
                                    <text x="50" y="24" textAnchor="middle" fill="#E1C284" fontSize="16" fontFamily="serif" fontWeight="bold" letterSpacing="0.5">CupiCho</text>
                                    <text x="50" y="36" textAnchor="middle" fill="#E1C284" fontSize="7" fontFamily="sans-serif" letterSpacing="1">丘比巧</text>
                                </svg>
                            }
                        </div>
                        <div className="flex-1 flex items-start pt-2 pl-1">
                            <div className="flex items-baseline" style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>
                                <span style={{ fontSize: '14pt', marginRight: '3px' }}>$</span>
                                <span style={{ fontSize: '20pt', lineHeight: '1' }}>{tag.price}</span>
                            </div>
                        </div>
                        <div className="mt-auto mb-1 w-full pl-1">
                            <div style={{ fontFamily: '"Libre Barcode 39", cursive', fontSize: '40px', color: '#E1C284', lineHeight: 0.7, whiteSpace: 'nowrap', marginLeft: '-10px', transform: 'scaleX(0.6)', transformOrigin: 'left bottom', marginBottom: '2px' }}>
                                {tag.itemNo ? `*${tag.itemNo}*` : ''}
                            </div>
                            <div className="text-[9px] font-serif tracking-widest text-[#E1C284] leading-none">{tag.itemNo}</div>
                        </div>
                    </div>
                    <div className="w-[65%] h-full flex flex-col pr-4 py-3 pl-1 relative z-10">
                        <div style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif', fontSize: '18pt', lineHeight: '1.2', marginBottom: '4px' }}>{tag.brand}</div>
                        <div style={{ fontFamily: '"Kinuta KinutaMincho StdN R", serif', fontSize: '14pt', lineHeight: '1.3', marginBottom: '2px' }}>{tag.name}</div>
                        <div style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif', fontSize: '6pt', lineHeight: '1.2', textTransform: 'uppercase', letterSpacing: '0.5px', opacity: 0.9 }}>{tag.engName}</div>
                        <div className="flex gap-5 absolute bottom-3 right-4" style={{ fontSize: '10pt' }}>
                            <span style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>{tag.weight}</span>
                            <span style={{ fontFamily: '"Kinuta KinutaMincho StdN R", serif' }}>{tag.country}</span>
                        </div>
                    </div>
                </div>
            );

            const currentEditingTag = tags.find(t => t.id === editingId);

            return (
                <div className="min-h-screen bg-[#1a0e0b] flex flex-col max-w-md mx-auto relative shadow-2xl font-sans">
                    <input type="file" ref={fileInputRef} onChange={handleLogoUpload} accept="image/*" className="hidden" />
                    <input type="file" ref={csvInputRef} onChange={handleCSVUpload} accept=".csv" className="hidden" />

                    <header className="bg-[#2B130F] px-4 py-3 flex items-center justify-between border-b border-[#E1C284]/20 sticky top-0 z-20 shadow-lg no-print">
                        <div className="flex items-center gap-2">
                            <div className="text-[#E1C284]"><Icon name="Palette" size={20}/></div>
                            <div>
                                <h1 className="font-bold text-[#E1C284] text-base tracking-widest">CUPICHO</h1>
                                <p className="text-[#E1C284]/60 text-[10px] flex items-center gap-1">
                                    <Icon name="Save" size={10} className="animate-pulse"/> Auto-Save
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowKeyModal(true)} className={`p-2 rounded-lg border ${apiKey ? 'bg-[#E1C284]/20 border-[#E1C284] text-[#E1C284]' : 'bg-[#2B130F] border-[#E1C284]/30 text-[#E1C284]/50'}`} title="API Key"><Icon name="Key" size={18}/></button>
                            <button onClick={() => csvInputRef.current.click()} className="bg-[#2B130F] border border-[#E1C284]/50 text-[#E1C284] p-2 rounded-lg"><Icon name="FileSpreadsheet" size={18}/></button>
                            <button onClick={() => fileInputRef.current.click()} className="bg-[#2B130F] border border-[#E1C284]/50 text-[#E1C284] p-2 rounded-lg"><Icon name="Image" size={18}/></button>
                            <button onClick={() => { setView('preview'); setTimeout(() => window.print(), 800); }} className="bg-[#E1C284] text-[#2B130F] p-2 rounded-lg font-bold flex items-center gap-1"><Icon name="Printer" size={18}/></button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 pb-28 no-print">
                        {view === 'list' ? (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-1">
                                    <span className="text-[10px] font-bold text-[#E1C284]/60 uppercase tracking-widest">List ({tags.length})</span>
                                    <div className="flex gap-2">
                                        <button onClick={handleResetData} className="text-[#E1C284]/30 hover:text-[#E1C284] p-1"><Icon name="RotateCcw" size={14}/></button>
                                        <button onClick={handleBatchTranslate} disabled={isBatchTranslating} className="flex items-center gap-1 bg-gradient-to-r from-purple-900 to-[#2B130F] border border-[#E1C284]/50 text-[#E1C284] px-3 py-1.5 rounded-full text-xs font-bold shadow-lg active:scale-95 transition-all">
                                            {isBatchTranslating ? <Icon name="Loader2" size={12} className="animate-spin"/> : <Icon name="Sparkles" size={12}/>}
                                            {isBatchTranslating ? 'Translating...' : 'AI Translate'}
                                        </button>
                                    </div>
                                </div>
                                {isBatchTranslating && (
                                    <div className="bg-[#E1C284]/10 rounded-lg p-3 border border-[#E1C284]/20 flex flex-col gap-2">
                                        <div className="flex justify-between items-center text-xs text-[#E1C284]">
                                            <span className="flex items-center gap-1"><Icon name="Loader2" size={10} className="animate-spin"/> Processing</span>
                                            <span>Slow Mode</span>
                                        </div>
                                        <div className="bg-[#2B130F] rounded-full h-1.5 overflow-hidden"><div className="bg-[#E1C284] h-full animate-pulse w-full"></div></div>
                                        <p className="text-[10px] text-[#E1C284]/80 text-center font-mono">{translateProgress}</p>
                                    </div>
                                )}
                                {tags.map(tag => (
                                    <div key={tag.id} className="bg-[#3e2b27] p-4 rounded-sm border border-[#E1C284]/30 shadow-md flex items-center justify-between active:scale-[0.98]" onClick={() => setEditingId(tag.id)}>
                                        <div className="flex-1 min-w-0 pr-3">
                                            <div className="flex items-center gap-2 mb-1"><span className="text-[10px] font-mono text-[#E1C284]/70">#{tag.itemNo}</span></div>
                                            <p className="font-bold text-[#E1C284] truncate text-lg font-serif">{tag.name}</p>
                                            {!tag.engName ? <p className="text-[10px] text-red-400/80 italic flex items-center gap-1"><Icon name="AlertCircle" size={10}/> Missing English</p> : <p className="text-[10px] text-[#E1C284]/80 truncate uppercase">{tag.engName}</p>}
                                        </div>
                                        <div className="flex flex-col items-end gap-1">
                                            <span className="text-xl font-serif text-[#E1C284]">${tag.price}</span>
                                            <button className="p-2 text-[#E1C284]/50 hover:text-red-400" onClick={(e) => { e.stopPropagation(); setDeleteConfirmId(tag.id); }}><Icon name="Trash2" size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="flex flex-col items-center space-y-6">
                                <div className="w-full flex justify-between items-center px-2 bg-[#E1C284]/10 p-2 rounded-lg border border-[#E1C284]/20">
                                    <span className="text-[10px] font-bold text-[#E1C284] uppercase flex items-center gap-1"><Icon name="Eye" size={12}/> Preview</span>
                                    <span className="text-[10px] text-[#E1C284] font-bold">80x50mm</span>
                                </div>
                                <div className="w-full flex flex-col items-center gap-6">
                                    {tags.map(tag => <div key={tag.id} className="shadow-2xl shadow-black/50 origin-top"><PriceTag tag={tag} /></div>)}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* 列印專用區塊 (只在列印時顯示) */}
                    <div className="hidden print-container">
                        {tags.map(tag => <div key={tag.id}><PriceTag tag={tag} /></div>)}
                    </div>

                    <nav className="bg-[#2B130F] border-t border-[#E1C284]/20 px-6 py-2 flex justify-around items-center fixed bottom-0 left-0 right-0 max-w-md mx-auto z-30 shadow-2xl pb-safe no-print">
                        <button onClick={() => setView('list')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'list' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}><Icon name="Settings2" size={24} /><span className="text-[10px] font-serif tracking-widest">LIST</span></button>
                        <div className="w-12"></div>
                        <button onClick={() => setView('preview')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'preview' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}><Icon name="Eye" size={24} /><span className="text-[10px] font-serif tracking-widest">PREVIEW</span></button>
                    </nav>

                    <button onClick={addTag} className="fixed bottom-8 left-1/2 -translate-x-1/2 w-16 h-16 bg-[#E1C284] text-[#2B130F] rounded-full shadow-[0_0_20px_rgba(225,194,132,0.4)] flex items-center justify-center active:scale-95 transition-transform z-40 border-4 border-[#2B130F] no-print" style={{display: (view === 'list' && !editingId && !deleteConfirmId && !csvImportData && !showKeyModal) ? 'flex' : 'none'}}><Icon name="Plus" size={32} /></button>

                    {/* Modals & Drawers */}
                    {showKeyModal && (
                        <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl relative">
                                <button onClick={() => setShowKeyModal(false)} className="absolute top-2 right-2 text-[#E1C284]/50"><Icon name="X" size={16}/></button>
                                <div className="flex flex-col items-center mb-4"><Icon name="Sparkles" className="text-[#E1C284] mb-2" size={32} /><h3 className="font-serif text-lg text-[#E1C284] text-center">AI Settings</h3></div>
                                <p className="text-[#E1C284]/70 text-xs mb-4 text-center">輸入 Gemini API Key 以啟用翻譯。<br/>(Key 僅儲存在您的瀏覽器中)</p>
                                <input type="password" placeholder="Paste API Key here..." value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full px-3 py-2 bg-[#1a0e0b] text-[#E1C284] border border-[#E1C284]/30 rounded-sm mb-4 outline-none text-sm"/>
                                <button onClick={() => setShowKeyModal(false)} className="w-full py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold text-sm">Save & Close</button>
                            </div>
                        </div>
                    )}

                    {csvImportData && (
                        <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <h3 className="font-serif text-lg text-[#E1C284] text-center mb-4">CSV Import</h3>
                                <p className="text-[#E1C284]/80 text-sm text-center font-serif mb-6">成功讀取 {csvImportData.length} 筆資料。</p>
                                <div className="flex flex-col gap-3">
                                    <button onClick={() => confirmImport('overwrite')} className="w-full py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold text-sm">覆蓋清單</button>
                                    <button onClick={() => confirmImport('append')} className="w-full py-3 bg-[#3e2b27] text-[#E1C284] rounded-sm font-bold text-sm border border-[#E1C284]/30">追加至現有</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingId && currentEditingTag && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex flex-col justify-end backdrop-blur-[2px]">
                            <div className="bg-[#2B130F] border-t border-[#E1C284]/30 rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto animate-in slide-in-from-bottom duration-300 shadow-2xl">
                                <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-serif text-[#E1C284] flex items-center gap-2 italic">Edit Product</h3><button onClick={() => setEditingId(null)} className="p-2 bg-[#E1C284]/10 rounded-full text-[#E1C284]"><Icon name="X" size={20}/></button></div>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="col-span-2 space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">ITEM NO.</label><input type="text" value={currentEditingTag.itemNo} onChange={(e) => updateTag(editingId, 'itemNo', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-mono text-sm border border-[#E1C284]/20"/></div>
                                        <div className="col-span-1 space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">COUNTRY</label><input type="text" value={currentEditingTag.country} onChange={(e) => updateTag(editingId, 'country', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none text-sm text-center border border-[#E1C284]/20 font-serif"/></div>
                                    </div>
                                    <div className="space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">BRAND</label><input type="text" value={currentEditingTag.brand} onChange={(e) => updateTag(editingId, 'brand', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-sm border border-[#E1C284]/20"/></div>
                                    <div className="space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">NAME (CHI)</label><input type="text" value={currentEditingTag.name} onChange={(e) => updateTag(editingId, 'name', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-lg border border-[#E1C284]/20"/></div>
                                    <div className="flex gap-2 items-end">
                                        <div className="flex-1 space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">NAME (ENG)</label><input type="text" value={currentEditingTag.engName} onChange={(e) => updateTag(editingId, 'engName', e.target.value)} className="w-full px-3 py-2 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-xs border border-[#E1C284]/20 uppercase"/></div>
                                        <button onClick={async () => { if(!apiKey) { setShowKeyModal(true); return; } setIsSingleTranslating(true); const res = await callGeminiAPI(currentEditingTag.name); if(res) updateTag(editingId, 'engName', res); setIsSingleTranslating(false); }} disabled={isSingleTranslating} className="mb-[1px] h-[34px] px-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold text-[10px] flex items-center gap-1 shadow-md active:scale-95 transition-all whitespace-nowrap">{isSingleTranslating ? <Icon name="Loader2" size={12} className="animate-spin"/> : <Icon name="Sparkles" size={12}/>} AI</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">PRICE $</label><input type="number" value={currentEditingTag.price} onChange={(e) => updateTag(editingId, 'price', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-2xl border border-[#E1C284]/20"/></div>
                                        <div className="space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">WEIGHT</label><input type="text" value={currentEditingTag.weight} onChange={(e) => updateTag(editingId, 'weight', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-sm border border-[#E1C284]/20"/></div>
                                    </div>
                                    <div className="py-4 flex justify-center bg-[#1a0e0b] rounded-sm overflow-hidden mt-4 border border-[#E1C284]/10"><div className="transform scale-90 origin-center shadow-lg"><PriceTag tag={currentEditingTag} /></div></div>
                                    <button onClick={() => setEditingId(null)} className="w-full py-4 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold flex items-center justify-center gap-2 shadow-lg active:scale-[0.98] transition-all font-serif tracking-widest"><Icon name="Check" size={20}/> SAVE</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {deleteConfirmId && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <h3 className="font-serif text-lg text-[#E1C284] mb-2 text-center">Delete Item?</h3>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setDeleteConfirmId(null)} className="flex-1 py-3 bg-[#1a0e0b] text-[#E1C284]/60 rounded-sm font-serif text-sm border border-[#E1C284]/20">Cancel</button>
                                    <button onClick={() => deleteTag(deleteConfirmId)} className="flex-1 py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-serif font-bold text-sm">Delete</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {errorMsg && (
                        <div className="fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-red-500 rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <div className="flex flex-col items-center"><Icon name="AlertCircle" className="text-red-500 mb-2" size={32}/><p className="text-red-500 text-center font-bold mb-4">{errorMsg}</p><button onClick={() => setErrorMsg(null)} className="w-full py-2 bg-red-500/20 text-red-500 border border-red-500 rounded-sm">Close</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
