<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CupiCho Price Tag System v4.2</title>
    
    <!-- 1. 載入 Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 核心 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. 載入 Babel (讓瀏覽器看得懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 載入字型 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Barcode+39&family=Noto+Serif+TC:wght@400;700&family=Shippori+Mincho&display=swap');
        
        /* 補強列印樣式 */
        @media print {
            @page { 
                size: A4; 
                margin: 10mm 5mm; 
            }
            
            body { 
                background-color: white !important; 
                margin: 0 !important;
                padding: 0 !important;
                min-height: auto !important;
            }

            #root {
                background-color: white !important;
            }

            /* 隱藏所有非列印元素 */
            .no-print { display: none !important; }

            /* 強制移除所有陰影 */
            * {
                box-shadow: none !important;
                text-shadow: none !important;
            }

            /* 列印容器設定 */
            .print-container { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; /* 雙欄排列 */
                gap: 5mm !important; /* 標籤間距 */
                width: 100% !important; 
                background-color: transparent !important;
                padding: 0 !important; 
                justify-content: center !important;
            }

            /* 標籤本體設定 */
            .cupicho-tag { 
                border: 1px dashed #ccc !important; /* 裁切線 */
                break-inside: avoid !important; /* 禁止標籤被切成兩半 */
                page-break-inside: avoid !important;
                margin: 0 auto !important; 
                background-color: #2B130F !important; /* 只有標籤有顏色 */
                color: #E1C284 !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
        }
    </style>
</head>
<body class="bg-[#1a0e0b] min-h-screen text-[#E1C284]">
    <div id="root"></div>

    <!-- 5. React 程式碼邏輯 -->
    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef, useMemo } = React;
        const VERSION = "v4.2 Inventory Pro"; 
        
        // 圖示組件
        const Icon = ({ name, size = 18, className }) => {
            const icons = {
                Plus: <path d="M5 12h14M12 5v14" />,
                Minus: <path d="M5 12h14" />,
                Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
                Printer: <><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>,
                Edit3: <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                Check: <polyline points="20 6 9 17 4 12" />,
                Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></>,
                List: <><line x1="8" x2="21" y1="6" y2="6" /><line x1="8" x2="21" y1="12" y2="12" /><line x1="8" x2="21" y1="18" y2="18" /><line x1="3" x2="3.01" y1="6" y2="6" /><line x1="3" x2="3.01" y1="12" y2="12" /><line x1="3" x2="3.01" y1="18" y2="18" /></>,
                Palette: <circle cx="13.5" cy="6.5" r=".5" fill="currentColor" />,
                Image: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></>,
                FileSpreadsheet: <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></>,
                Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
                AlertCircle: <><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></>,
                Save: <><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" /><path d="M17 21v-8H7v8" /><path d="M7 3v5h8" /></>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" />,
                Globe: <><circle cx="12" cy="12" r="10" /><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" /><path d="M2 12h20" /></>,
                Search: <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
                Database: <><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></>,
                ClearAll: <><path d="M3 6h18" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /></>
            };
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const App = () => {
            const defaultTags = [
                { 
                id: '1001', 
                brand: 'CUPICHO', 
                name: '艾美黛黃金水果手工巧克力(5顆)',
                engName: 'Amedei Golden Fruit Handmade Chocolate (5pcs)',
                weight: '55g', 
                price: '580', 
                country: 'Italy', 
                itemNo: '2023001' 
                }
            ];

            // 狀態管理
            const [inventory, setInventory] = useState(defaultTags); // 庫存區
            const [tags, setTags] = useState([]); // 待列印區
            
            const [customLogo, setCustomLogo] = useState(null);
            const [isLoaded, setIsLoaded] = useState(false);
            
            // 視圖與操作
            const [view, setView] = useState('inventory'); // 'inventory' | 'list' | 'preview'
            const [searchTerm, setSearchTerm] = useState('');
            const [editingId, setEditingId] = useState(null); 
            const [editSource, setEditSource] = useState('inventory'); 
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const [clearConfirm, setClearConfirm] = useState(false); // 清空確認視窗
            const [csvImportData, setCsvImportData] = useState(null);
            const [errorMsg, setErrorMsg] = useState(null);

            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);

            // 初始化讀取
            useEffect(() => {
                const loadData = () => {
                try {
                    const savedInventory = localStorage.getItem('cupicho_inventory');
                    const savedTags = localStorage.getItem('cupicho_print_list');
                    const savedLogo = localStorage.getItem('cupicho_logo');

                    if (savedInventory) setInventory(JSON.parse(savedInventory));
                    if (savedTags) setTags(JSON.parse(savedTags));
                    if (savedLogo) setCustomLogo(savedLogo);
                } catch (error) {
                    console.error("讀取儲存資料失敗:", error);
                } finally {
                    setIsLoaded(true);
                }
                };
                loadData();
            }, []);

            // 自動存檔
            useEffect(() => {
                if (isLoaded) {
                    localStorage.setItem('cupicho_inventory', JSON.stringify(inventory));
                    localStorage.setItem('cupicho_print_list', JSON.stringify(tags));
                }
            }, [inventory, tags, isLoaded]);

            useEffect(() => {
                if (isLoaded && customLogo) {
                try {
                    localStorage.setItem('cupicho_logo', customLogo);
                } catch (e) {
                    console.warn("Logo 太大無法儲存");
                }
                }
            }, [customLogo, isLoaded]);

            // 過濾庫存 (搜尋功能)
            const filteredInventory = useMemo(() => {
                if (!searchTerm) return inventory;
                const lowerTerm = searchTerm.toLowerCase();
                return inventory.filter(item => 
                    item.name.toLowerCase().includes(lowerTerm) || 
                    item.itemNo.toLowerCase().includes(lowerTerm) ||
                    (item.engName && item.engName.toLowerCase().includes(lowerTerm))
                );
            }, [inventory, searchTerm]);

            // 計算待印清單中某商品的數量
            const getPrintCount = (itemNo) => {
                return tags.filter(t => t.itemNo === itemNo).length;
            };

            // 操作：增加一張
            const addOneTag = (item) => {
                const newItem = { ...item, id: Date.now().toString() + Math.random() };
                setTags([newItem, ...tags]);
            };

            // 操作：減少一張 (移除最近加入的該商品)
            const removeOneTag = (itemNo) => {
                const index = tags.findIndex(t => t.itemNo === itemNo);
                if (index !== -1) {
                    const newTags = [...tags];
                    newTags.splice(index, 1);
                    setTags(newTags);
                }
            };

            // 清空待印清單 (確認邏輯在 Modal)
            const confirmClearPrintList = () => {
                setTags([]);
                setClearConfirm(false);
            };

            const handleLogoUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (file.size > 1024 * 1024) {
                    setErrorMsg("圖片檔案過大 (超過 1MB)，建議壓縮後再上傳。");
                }
                const reader = new FileReader();
                reader.onloadend = () => setCustomLogo(reader.result);
                reader.readAsDataURL(file);
            };

            const addNewToInventory = () => {
                const randomNo = Math.floor(100000 + Math.random() * 900000).toString();
                const newItem = { 
                    id: Date.now().toString(), brand: 'CUPICHO', name: '新商品', engName: '', 
                    weight: '100g', price: '0', country: 'Taiwan', itemNo: randomNo 
                };
                setInventory([newItem, ...inventory]);
                setEditingId(newItem.id);
                setEditSource('inventory');
            };

            const updateItem = (id, field, value) => {
                if (editSource === 'inventory') {
                    setInventory(inventory.map(t => t.id === id ? { ...t, [field]: value } : t));
                } else {
                    setTags(tags.map(t => t.id === id ? { ...t, [field]: value } : t));
                }
            };

            const deleteItem = (id) => {
                if (editSource === 'inventory') {
                    setInventory(inventory.filter(t => t.id !== id));
                } else {
                    setTags(tags.filter(t => t.id !== id));
                }
                setDeleteConfirmId(null);
                if (editingId === id) setEditingId(null);
            };

            // CSV 匯入 (匯入到庫存)
            const handleCSVUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = text.split(/\r\n|\n/);
                        if (rows.length < 2) { setErrorMsg('CSV 內容太少'); return; }
                        
                        const headerRow = rows[0].toUpperCase();
                        const headers = headerRow.split(',').map(h => h.trim());
                        
                        const fieldKeywords = {
                            itemNo: ['ITEM NO', 'NO.', '品號'], brand: ['BRAND', '品牌'],
                            name: ['NAME (CHI)', '品名', '中文'], engName: ['NAME (ENG)', '英文'],
                            price: ['PRICE', '價格', '$'], weight: ['WEIGHT', '重量'], country: ['COUNTRY', '國家']
                        };
                        
                        const getIndex = (key) => headers.findIndex(h => fieldKeywords[key].some(k => h.includes(k)));
                        const indices = {
                            itemNo: getIndex('itemNo'), brand: getIndex('brand'), name: getIndex('name'),
                            engName: getIndex('engName'), price: getIndex('price'), weight: getIndex('weight'), country: getIndex('country')
                        };
                        
                        const isSmartMode = indices.name !== -1 || indices.price !== -1;
                        const newItems = [];
                        
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i].trim();
                            if (!row) continue;
                            const cols = row.split(',');
                            const getData = (key, fallback) => {
                                const idx = isSmartMode ? indices[key] : fallback;
                                return (idx !== -1 && cols[idx]) ? cols[idx].trim() : '';
                            };
                            
                            const rawName = getData('name', 2) || '未命名';
                            if (cols.length >= 2) {
                                newItems.push({
                                    id: Date.now() + i + Math.random(),
                                    itemNo: getData('itemNo', 0) || '000000',
                                    brand: getData('brand', 1) || 'CUPICHO',
                                    name: rawName,
                                    engName: getData('engName', 3) || '',
                                    price: getData('price', 4) || '0',
                                    weight: getData('weight', 5) || '',
                                    country: getData('country', 6) || ''
                                });
                            }
                        }
                        if (newItems.length > 0) setCsvImportData(newItems);
                        else setErrorMsg('CSV 解析失敗');
                    } catch (e) { setErrorMsg('讀取錯誤'); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const confirmImport = (mode) => {
                if (mode === 'overwrite') setInventory(csvImportData);
                else setInventory([...csvImportData, ...inventory]);
                setCsvImportData(null);
                setView('inventory');
                alert(`成功匯入 ${csvImportData.length} 筆商品到庫存！`);
            };

            const downloadTemplate = () => {
                const csvContent = "\ufeffITEM NO.,BRAND,NAME (CHI),NAME (ENG),PRICE $,WEIGHT,COUNTRY\n2023001,CUPICHO,範例巧克力,,580,55g,Italy\n";
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                link.download = "cupicho_template.csv";
                link.click();
            };

            // 標籤組件
            const PriceTag = ({ tag }) => (
                <div className="cupicho-tag relative flex overflow-hidden box-border" style={{ width: '80mm', height: '50mm', backgroundColor: '#2B130F', color: '#E1C284', fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>
                    <div className="w-[35%] h-full flex flex-col pl-3 py-3 relative z-10">
                        <div className="h-[30%] flex items-start -ml-1">
                            {customLogo ? 
                                <img src={customLogo} className="w-[90%] h-full object-contain object-left-top"/> : 
                                <svg viewBox="0 0 100 45" className="w-[90%] h-auto">
                                    <ellipse cx="50" cy="22.5" rx="48" ry="20" fill="none" stroke="#E1C284" strokeWidth="1.5" />
                                    <ellipse cx="50" cy="22.5" rx="45" ry="17" fill="none" stroke="#E1C284" strokeWidth="0.5" opacity="0.5"/>
                                    <text x="50" y="24" textAnchor="middle" fill="#E1C284" fontSize="16" fontFamily="serif" fontWeight="bold" letterSpacing="0.5">CupiCho</text>
                                    <text x="50" y="36" textAnchor="middle" fill="#E1C284" fontSize="7" fontFamily="sans-serif" letterSpacing="1">丘比巧</text>
                                </svg>
                            }
                        </div>
                        <div className="flex-1 flex items-start pt-2 pl-1">
                            <div className="flex items-baseline" style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>
                                <span style={{ fontSize: '14pt', marginRight: '3px' }}>$</span>
                                <span style={{ fontSize: '20pt', lineHeight: '1' }}>{tag.price}</span>
                            </div>
                        </div>
                        <div className="mt-auto mb-1 w-full pl-1">
                            <div style={{ fontFamily: '"Libre Barcode 39", cursive', fontSize: '40px', color: '#E1C284', lineHeight: 0.7, whiteSpace: 'nowrap', marginLeft: '-10px', transform: 'scaleX(0.9)', transformOrigin: 'left bottom', marginBottom: '2px' }}>
                                {tag.itemNo ? `*${tag.itemNo}*` : ''}
                            </div>
                            <div className="text-[9px] font-serif tracking-widest text-[#E1C284] leading-none">{tag.itemNo}</div>
                        </div>
                    </div>
                    <div className="w-[65%] h-full flex flex-col pr-4 py-3 pl-1 relative z-10">
                        <div style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif', fontSize: '18pt', lineHeight: '1.2', marginBottom: '4px' }}>{tag.brand}</div>
                        <div style={{ fontFamily: '"Kinuta KinutaMincho StdN R", serif', fontSize: '14pt', lineHeight: '1.3', marginBottom: '2px' }}>{tag.name}</div>
                        <div style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif', fontSize: '6pt', lineHeight: '1.2', textTransform: 'uppercase', letterSpacing: '0.5px', opacity: 0.9 }}>{tag.engName}</div>
                        <div className="flex gap-5 absolute bottom-3 right-4" style={{ fontSize: '10pt' }}>
                            <span style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>{tag.weight}</span>
                            <span style={{ fontFamily: '"Kinuta KinutaMincho StdN R", serif' }}>{tag.country}</span>
                        </div>
                    </div>
                </div>
            );

            const currentEditingTag = editingId ? (editSource === 'inventory' ? inventory.find(t => t.id === editingId) : tags.find(t => t.id === editingId)) : null;

            return (
                <div className="min-h-screen bg-[#1a0e0b] flex flex-col max-w-md mx-auto relative shadow-2xl font-sans text-[#E1C284]">
                    <input type="file" ref={fileInputRef} onChange={handleLogoUpload} accept="image/*" className="hidden" />
                    <input type="file" ref={csvInputRef} onChange={handleCSVUpload} accept=".csv" className="hidden" />

                    <header className="bg-[#2B130F] px-4 py-3 flex items-center justify-between border-b border-[#E1C284]/20 sticky top-0 z-20 shadow-lg no-print">
                        <div className="flex items-center gap-2">
                            <div className="text-[#E1C284]"><Icon name="Palette" size={20}/></div>
                            <div>
                                <div className="flex items-center gap-2">
                                    <h1 className="font-bold text-[#E1C284] text-base tracking-widest">CUPICHO</h1>
                                    <span className="text-[10px] bg-[#E1C284]/20 text-[#E1C284] px-1.5 py-0.5 rounded border border-[#E1C284]/30">{VERSION}</span>
                                </div>
                                <p className="text-[#E1C284]/60 text-[10px] flex items-center gap-1">
                                    <Icon name="Save" size={10} className="animate-pulse"/> 自動存檔
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => fileInputRef.current.click()} className="bg-[#2B130F] border border-[#E1C284]/50 text-[#E1C284] p-2 rounded-lg" title="更換 Logo"><Icon name="Image" size={18}/></button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 pb-28 no-print">
                        
                        {/* 1. 庫存管理視圖 */}
                        {view === 'inventory' && (
                            <div className="space-y-4">
                                <div className="bg-[#2B130F] p-4 rounded-sm border border-[#E1C284]/30">
                                    <h2 className="font-bold text-lg mb-3 flex items-center gap-2"><Icon name="Database" size={20}/> 商品庫存 (共 {inventory.length} 筆)</h2>
                                    <div className="flex gap-2 mb-3">
                                        <div className="flex-1 relative">
                                            <div className="absolute left-3 top-2.5 text-[#E1C284]/50"><Icon name="Search" size={16}/></div>
                                            <input 
                                                type="text" 
                                                placeholder="搜尋品名、編號..." 
                                                value={searchTerm}
                                                onChange={(e) => setSearchTerm(e.target.value)}
                                                className="w-full pl-9 pr-3 py-2 bg-[#3e2b27] border border-[#E1C284]/30 rounded-sm text-[#E1C284] outline-none placeholder-[#E1C284]/30"
                                            />
                                        </div>
                                    </div>
                                    <div className="flex gap-2 text-xs">
                                        <button onClick={() => csvInputRef.current.click()} className="flex items-center gap-1 bg-[#E1C284]/20 px-3 py-1.5 rounded-full border border-[#E1C284]/30 hover:bg-[#E1C284]/30"><Icon name="FileSpreadsheet" size={12}/> 匯入 CSV</button>
                                        <button onClick={downloadTemplate} className="flex items-center gap-1 bg-[#E1C284]/20 px-3 py-1.5 rounded-full border border-[#E1C284]/30 hover:bg-[#E1C284]/30"><Icon name="Download" size={12}/> 範本</button>
                                        <button onClick={addNewToInventory} className="flex items-center gap-1 bg-[#E1C284] text-[#2B130F] px-3 py-1.5 rounded-full font-bold ml-auto"><Icon name="Plus" size={12}/> 新增</button>
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    {filteredInventory.length === 0 ? (
                                        <div className="py-10 text-center opacity-50">沒有找到相關商品。</div>
                                    ) : (
                                        filteredInventory.map(item => {
                                            const count = getPrintCount(item.itemNo);
                                            return (
                                                <div key={item.id} className="bg-[#3e2b27] p-3 rounded-sm border border-[#E1C284]/20 flex justify-between items-center group hover:border-[#E1C284]/50">
                                                    <div className="flex-1 min-w-0 pr-2 cursor-pointer" onClick={() => { setEditingId(item.id); setEditSource('inventory'); }}>
                                                        <div className="text-[10px] text-[#E1C284]/60 font-mono">#{item.itemNo}</div>
                                                        <div className="font-bold truncate">{item.name}</div>
                                                        <div className="text-xs opacity-70">${item.price}</div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button 
                                                            onClick={() => { setEditingId(item.id); setEditSource('inventory'); }}
                                                            className="p-2 text-[#E1C284]/50 hover:text-[#E1C284]"
                                                        >
                                                            <Icon name="Edit3" size={16}/>
                                                        </button>
                                                        
                                                        {/* 計數器按鈕邏輯 */}
                                                        {count > 0 ? (
                                                            <div className="flex items-center bg-[#2B130F] border border-[#E1C284] rounded-sm overflow-hidden h-8">
                                                                <button onClick={() => removeOneTag(item.itemNo)} className="px-2 h-full hover:bg-[#E1C284]/20 active:bg-[#E1C284]/40 flex items-center justify-center">
                                                                    <Icon name="Minus" size={12}/>
                                                                </button>
                                                                <span className="px-2 text-xs font-bold text-[#E1C284] border-x border-[#E1C284]/30 h-full flex items-center justify-center min-w-[24px]">
                                                                    {count}
                                                                </span>
                                                                <button onClick={() => addOneTag(item)} className="px-2 h-full hover:bg-[#E1C284]/20 active:bg-[#E1C284]/40 flex items-center justify-center">
                                                                    <Icon name="Plus" size={12}/>
                                                                </button>
                                                            </div>
                                                        ) : (
                                                            <button 
                                                                onClick={() => addOneTag(item)}
                                                                className="bg-[#2B130F] border border-[#E1C284] text-[#E1C284] text-xs px-3 py-1.5 rounded-sm active:bg-[#E1C284] active:text-[#2B130F] transition-all flex items-center gap-1"
                                                            >
                                                                <Icon name="Plus" size={12}/> 加入
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        )}

                        {/* 2. 待印清單視圖 */}
                        {view === 'list' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-1">
                                    <h2 className="font-bold text-lg flex items-center gap-2"><Icon name="List" size={20}/> 待印清單 ({tags.length})</h2>
                                    {tags.length > 0 && (
                                        <button onClick={() => setClearConfirm(true)} className="text-xs text-red-400 border border-red-400/50 px-2 py-1 rounded-sm hover:bg-red-400/20 flex items-center gap-1">
                                            <Icon name="Trash2" size={12}/> 清空
                                        </button>
                                    )}
                                </div>
                                
                                {tags.length === 0 ? (
                                    <div className="py-20 text-center opacity-50 flex flex-col items-center gap-2">
                                        <Icon name="List" size={48} />
                                        <p>目前沒有待印標籤</p>
                                        <button onClick={() => setView('inventory')} className="text-[#E1C284] underline text-sm mt-2">去庫存挑選商品</button>
                                    </div>
                                ) : (
                                    tags.map(tag => (
                                        <div key={tag.id} className="bg-[#3e2b27] p-4 rounded-sm border border-[#E1C284]/30 shadow-md flex items-center justify-between active:scale-[0.98]" onClick={() => { setEditingId(tag.id); setEditSource('list'); }}>
                                            <div className="flex-1 min-w-0 pr-3">
                                                <div className="flex items-center gap-2 mb-1"><span className="text-[10px] font-mono text-[#E1C284]/70">#{tag.itemNo}</span></div>
                                                <p className="font-bold text-[#E1C284] truncate text-lg font-serif">{tag.name}</p>
                                                {!tag.engName ? <p className="text-[10px] text-red-400/80 italic flex items-center gap-1"><Icon name="AlertCircle" size={10}/> 缺少英文</p> : <p className="text-[10px] text-[#E1C284]/80 truncate uppercase">{tag.engName}</p>}
                                            </div>
                                            <div className="flex flex-col items-end gap-1">
                                                <span className="text-xl font-serif text-[#E1C284]">${tag.price}</span>
                                                <button className="p-2 text-[#E1C284]/50 hover:text-red-400" onClick={(e) => { e.stopPropagation(); setDeleteConfirmId(tag.id); setEditSource('list'); }}><Icon name="Trash2" size={16}/></button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {/* 3. 預覽列印視圖 */}
                        {view === 'preview' && (
                            <div className="flex flex-col items-center space-y-6">
                                <div className="w-full flex justify-between items-center px-4 bg-[#E1C284]/10 p-2 rounded-lg border border-[#E1C284]/20">
                                    <span className="text-sm font-bold text-[#E1C284] uppercase flex items-center gap-1"><Icon name="Eye" size={16}/> 預覽 ({tags.length}張)</span>
                                    <button onClick={() => window.print()} className="bg-[#E1C284] text-[#2B130F] px-4 py-1.5 rounded-sm font-bold text-sm flex items-center gap-1 shadow-lg hover:scale-105 transition-transform"><Icon name="Printer" size={16}/> 立即列印</button>
                                </div>
                                <div className="w-full flex flex-col items-center gap-6 pb-20">
                                    {tags.length === 0 ? <div className="text-center py-10 opacity-50">沒有標籤可列印，請先加入商品。</div> : 
                                        tags.map(tag => <div key={tag.id} className="shadow-2xl shadow-black/50 origin-top"><PriceTag tag={tag} /></div>)
                                    }
                                </div>
                            </div>
                        )}
                    </main>

                    {/* 列印專用區塊 (只在列印時顯示) */}
                    <div className="hidden print-container">
                        {tags.map(tag => <div key={tag.id}><PriceTag tag={tag} /></div>)}
                    </div>

                    <nav className="bg-[#2B130F] border-t border-[#E1C284]/20 px-6 py-2 flex justify-around items-center fixed bottom-0 left-0 right-0 max-w-md mx-auto z-30 shadow-2xl pb-safe no-print">
                        <button onClick={() => setView('inventory')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'inventory' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}><Icon name="Database" size={24} /><span className="text-[10px] font-serif tracking-widest">庫存</span></button>
                        <div className="w-8"></div>
                        <button onClick={() => setView('list')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'list' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}>
                            <div className="relative">
                                <Icon name="List" size={24} />
                                {tags.length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full">{tags.length}</span>}
                            </div>
                            <span className="text-[10px] font-serif tracking-widest">待印</span>
                        </button>
                        <div className="w-8"></div>
                        <button onClick={() => setView('preview')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'preview' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}><Icon name="Eye" size={24} /><span className="text-[10px] font-serif tracking-widest">預覽</span></button>
                    </nav>

                    {/* Modals */}
                    {csvImportData && (
                        <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <h3 className="font-serif text-lg text-[#E1C284] text-center mb-4">確認匯入</h3>
                                <p className="text-[#E1C284]/80 text-sm text-center font-serif mb-6">成功讀取 {csvImportData.length} 筆資料。<br/>這將會更新您的庫存資料庫。</p>
                                <div className="flex flex-col gap-3">
                                    <button onClick={() => confirmImport('overwrite')} className="w-full py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold text-sm">覆蓋舊庫存</button>
                                    <button onClick={() => confirmImport('append')} className="w-full py-3 bg-[#3e2b27] text-[#E1C284] rounded-sm font-bold text-sm border border-[#E1C284]/30">追加到現有庫存</button>
                                    <button onClick={() => setCsvImportData(null)} className="w-full py-2 text-[#E1C284]/50 text-xs text-center">取消</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingId && currentEditingTag && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex flex-col justify-end backdrop-blur-[2px]">
                            <div className="bg-[#2B130F] border-t border-[#E1C284]/30 rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto animate-in slide-in-from-bottom duration-300 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-serif text-[#E1C284] flex items-center gap-2 italic">
                                        編輯商品 ({editSource === 'inventory' ? '庫存' : '待印'})
                                    </h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setDeleteConfirmId(editingId); }} className="p-2 bg-red-900/30 rounded-full text-red-400"><Icon name="Trash2" size={20}/></button>
                                        <button onClick={() => setEditingId(null)} className="p-2 bg-[#E1C284]/10 rounded-full text-[#E1C284]"><Icon name="X" size={20}/></button>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="col-span-2 space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">品號</label><input type="text" value={currentEditingTag.itemNo} onChange={(e) => updateItem(editingId, 'itemNo', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-mono text-sm border border-[#E1C284]/20"/></div>
                                        <div className="col-span-1 space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">國家</label><input type="text" value={currentEditingTag.country} onChange={(e) => updateItem(editingId, 'country', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none text-sm text-center border border-[#E1C284]/20 font-serif"/></div>
                                    </div>
                                    <div className="space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">品牌</label><input type="text" value={currentEditingTag.brand} onChange={(e) => updateItem(editingId, 'brand', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-sm border border-[#E1C284]/20"/></div>
                                    <div className="space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">中文品名</label><input type="text" value={currentEditingTag.name} onChange={(e) => updateItem(editingId, 'name', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-lg border border-[#E1C284]/20"/></div>
                                    <div className="flex gap-2 items-end">
                                        <div className="flex-1 space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">英文品名</label><input type="text" value={currentEditingTag.engName} onChange={(e) => updateItem(editingId, 'engName', e.target.value)} className="w-full px-3 py-2 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-xs border border-[#E1C284]/20 uppercase"/></div>
                                        <button onClick={() => window.open(`https://translate.google.com/?sl=zh-TW&tl=en&text=${encodeURIComponent(currentEditingTag.name)}&op=translate`, '_blank')} className="mb-[1px] h-[34px] px-3 bg-blue-100 text-blue-700 border border-blue-200 rounded-sm font-bold text-[10px] flex items-center gap-1 shadow-md active:scale-95 transition-all whitespace-nowrap ml-2" title="開啟 Google 翻譯網頁"><Icon name="Globe" size={12}/></button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">價格 $</label><input type="number" value={currentEditingTag.price} onChange={(e) => updateItem(editingId, 'price', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-2xl border border-[#E1C284]/20"/></div>
                                        <div className="space-y-1"><label className="text-[10px] font-serif text-[#E1C284]/60 ml-1">重量</label><input type="text" value={currentEditingTag.weight} onChange={(e) => updateItem(editingId, 'weight', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm focus:ring-1 focus:ring-[#E1C284] outline-none font-serif text-sm border border-[#E1C284]/20"/></div>
                                    </div>
                                    <div className="py-4 flex justify-center bg-[#1a0e0b] rounded-sm overflow-hidden mt-4 border border-[#E1C284]/10"><div className="transform scale-90 origin-center shadow-lg"><PriceTag tag={currentEditingTag} /></div></div>
                                    <button onClick={() => setEditingId(null)} className="w-full py-4 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold flex items-center justify-center gap-2 shadow-lg active:scale-[0.98] transition-all font-serif tracking-widest"><Icon name="Check" size={20}/> 儲存</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 刪除確認 Modal */}
                    {deleteConfirmId && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <h3 className="font-serif text-lg text-[#E1C284] mb-2 text-center">刪除此商品？</h3>
                                <p className="text-xs text-[#E1C284]/60 text-center mb-6">這將會從 {editSource === 'inventory' ? '庫存資料庫' : '待印清單'} 中移除。</p>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setDeleteConfirmId(null)} className="flex-1 py-3 bg-[#1a0e0b] text-[#E1C284]/60 rounded-sm font-serif text-sm border border-[#E1C284]/20">取消</button>
                                    <button onClick={() => deleteItem(deleteConfirmId)} className="flex-1 py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-serif font-bold text-sm">刪除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 清空確認 Modal (新功能) */}
                    {clearConfirm && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <h3 className="font-serif text-lg text-[#E1C284] mb-2 text-center">清空待印清單？</h3>
                                <p className="text-xs text-[#E1C284]/60 text-center mb-6">所有等待列印的標籤將會被移除 (庫存資料不會受影響)。</p>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setClearConfirm(false)} className="flex-1 py-3 bg-[#1a0e0b] text-[#E1C284]/60 rounded-sm font-serif text-sm border border-[#E1C284]/20">取消</button>
                                    <button onClick={confirmClearPrintList} className="flex-1 py-3 bg-red-600 text-white rounded-sm font-serif font-bold text-sm">確認清空</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {errorMsg && (
                        <div className="fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-red-500 rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <div className="flex flex-col items-center"><Icon name="AlertCircle" className="text-red-500 mb-2" size={32}/><p className="text-red-500 text-center font-bold mb-4">{errorMsg}</p><button onClick={() => setErrorMsg(null)} className="w-full py-2 bg-red-500/20 text-red-500 border border-red-500 rounded-sm">關閉</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
