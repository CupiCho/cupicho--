<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CupiCho Price Tag System v5.0</title>
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 核心 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 載入 Firebase (Compat版，適合直接在 HTML 使用) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- 5. 載入字型 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Libre+Barcode+39&family=Noto+Serif+TC:wght@400;700&family=Shippori+Mincho&display=swap');
        
        @media print {
            @page { size: A4; margin: 10mm 5mm; }
            body { background-color: white !important; margin: 0 !important; padding: 0 !important; }
            #root { background-color: white !important; }
            .no-print { display: none !important; }
            * { box-shadow: none !important; text-shadow: none !important; }
            .print-container { 
                display: grid !important; grid-template-columns: 1fr 1fr !important; 
                gap: 5mm !important; width: 100% !important; 
                background-color: transparent !important; padding: 0 !important; 
                justify-content: center !important;
            }
            .cupicho-tag { 
                border: 1px dashed #ccc !important; break-inside: avoid !important; 
                page-break-inside: avoid !important; margin: 0 auto !important; 
                background-color: #2B130F !important; color: #E1C284 !important; 
                -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; 
            }
        }
    </style>
</head>
<body class="bg-[#1a0e0b] min-h-screen text-[#E1C284]">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef, useMemo } = React;
        const VERSION = "v5.0 Cloud Sync"; 
        
        // Lucide Icons
        const Icon = ({ name, size = 18, className }) => {
            const icons = {
                Plus: <path d="M5 12h14M12 5v14" />,
                Minus: <path d="M5 12h14" />,
                Trash2: <><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>,
                Printer: <><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>,
                Edit3: <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" />,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                Check: <polyline points="20 6 9 17 4 12" />,
                Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></>,
                List: <><line x1="8" x2="21" y1="6" y2="6" /><line x1="8" x2="21" y1="12" y2="12" /><line x1="8" x2="21" y1="18" y2="18" /><line x1="3" x2="3.01" y1="6" y2="6" /><line x1="3" x2="3.01" y1="12" y2="12" /><line x1="3" x2="3.01" y1="18" y2="18" /></>,
                Palette: <circle cx="13.5" cy="6.5" r=".5" fill="currentColor" />,
                Image: <><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></>,
                FileSpreadsheet: <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></>,
                Download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />,
                AlertCircle: <><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></>,
                Save: <><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" /><path d="M17 21v-8H7v8" /><path d="M7 3v5h8" /></>,
                RotateCcw: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" />,
                Globe: <><circle cx="12" cy="12" r="10" /><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" /><path d="M2 12h20" /></>,
                Search: <><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>,
                Database: <><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></>,
                ClearAll: <><path d="M3 6h18" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /></>,
                Cloud: <><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19" /><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19" /><path d="M19 12h2" /><path d="M2 20v-8c0-2.209 1.791-4 4-4h2" /><path d="M12 4v4" /><path d="M4 12H2" /><path d="M12 20v-8c0-2.209 1.791-4 4-4h2" /></>,
                Wifi: <><path d="M5 12.55a11 11 0 0 1 14.08 0" /><path d="M1.42 9a16 16 0 0 1 21.16 0" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" x2="12.01" y1="20" y2="20" /></>,
                WifiOff: <><line x1="1" x2="23" y1="1" y2="23" /><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" /><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" /><path d="M10.71 5.05A16 16 0 0 1 22.58 9" /><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" /><path d="M8.53 16.11a6 6 0 0 1 6.95 0" /><line x1="12" x2="12.01" y1="20" y2="20" /></>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const App = () => {
            const defaultTags = [{ id: '1001', brand: 'CUPICHO', name: '艾美黛黃金水果手工巧克力(5顆)', engName: 'Amedei Golden Fruit Handmade Chocolate (5pcs)', weight: '55g', price: '580', country: 'Italy', itemNo: '2023001' }];

            // State
            const [inventory, setInventory] = useState(defaultTags);
            const [tags, setTags] = useState([]);
            const [customLogo, setCustomLogo] = useState(null);
            const [isLoaded, setIsLoaded] = useState(false);
            const [view, setView] = useState('inventory');
            const [searchTerm, setSearchTerm] = useState('');
            const [editingId, setEditingId] = useState(null); 
            const [editSource, setEditSource] = useState('inventory');
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const [clearConfirm, setClearConfirm] = useState(false);
            const [csvImportData, setCsvImportData] = useState(null);
            const [errorMsg, setErrorMsg] = useState(null);

            // Cloud Sync State
            const [showDbModal, setShowDbModal] = useState(false);
            const [firebaseConfigStr, setFirebaseConfigStr] = useState('');
            const [db, setDb] = useState(null);
            const [isCloudMode, setIsCloudMode] = useState(false);

            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);

            // Initialize Data & DB
            useEffect(() => {
                const loadData = () => {
                    try {
                        const savedLogo = localStorage.getItem('cupicho_logo');
                        const savedConfig = localStorage.getItem('cupicho_firebase_config');

                        if (savedLogo) setCustomLogo(savedLogo);

                        if (savedConfig) {
                            setFirebaseConfigStr(savedConfig);
                            initFirebase(savedConfig); // Try to connect
                        } else {
                            // Fallback to local storage if no cloud config
                            const savedInventory = localStorage.getItem('cupicho_inventory');
                            const savedTags = localStorage.getItem('cupicho_print_list');
                            if (savedInventory) setInventory(JSON.parse(savedInventory));
                            if (savedTags) setTags(JSON.parse(savedTags));
                        }
                    } catch (error) {
                        console.error("Init Error:", error);
                    } finally {
                        setIsLoaded(true);
                    }
                };
                loadData();
            }, []);

            // Firebase Initialization
            const initFirebase = (configStr) => {
                try {
                    let config;
                    try {
                        // 嘗試標準 JSON 解析
                        config = JSON.parse(configStr);
                    } catch (e) {
                        // 如果失敗，嘗試寬容解析 (處理使用者直接複製 JS 物件或程式碼的情況)
                        console.warn("JSON parse failed, trying loose parsing...");
                        // 1. 移除 `const firebaseConfig =` 或類似前綴
                        let cleanStr = configStr.replace(/^(const|var|let)\s+\w+\s*=\s*/, '').trim();
                        // 2. 移除結尾分號
                        if (cleanStr.endsWith(';')) cleanStr = cleanStr.slice(0, -1);
                        // 3. 使用 new Function 執行字串返回物件 (權宜之計，僅限於使用者自行輸入設定檔的情境)
                        config = new Function('return ' + cleanStr)();
                    }

                    if (config && !firebase.apps.length) {
                        firebase.initializeApp(config);
                    }
                    
                    const firestore = firebase.firestore();
                    setDb(firestore);
                    setIsCloudMode(true);
                    
                    // Subscribe to collections
                    const unsubInv = firestore.collection('inventory').onSnapshot(snapshot => {
                        const items = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        setInventory(items);
                    }, err => {
                        console.error("Firestore Inventory Error:", err);
                        setErrorMsg("無法讀取庫存，請檢查 Firebase 權限設定 (Rules)。");
                    });

                    const unsubTags = firestore.collection('print_list').onSnapshot(snapshot => {
                        const items = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        setTags(items);
                    }, err => {
                        console.error("Firestore Tags Error:", err);
                    });

                    return () => { unsubInv(); unsubTags(); };
                } catch (e) {
                    console.error("Firebase Init Failed:", e);
                    setIsCloudMode(false);
                    setErrorMsg("資料庫連線失敗，請檢查設定內容是否正確。");
                }
            };

            // Save Config
            const handleSaveConfig = () => {
                localStorage.setItem('cupicho_firebase_config', firebaseConfigStr);
                initFirebase(firebaseConfigStr);
                setShowDbModal(false);
                
                // Optional: Migrate local data to cloud
                if(inventory.length > 0 && confirm("是否將現有的本機庫存上傳到雲端？")){
                    const firestore = firebase.firestore();
                    const batch = firestore.batch();
                    inventory.forEach(item => {
                        const ref = firestore.collection('inventory').doc(item.id.toString());
                        batch.set(ref, item);
                    });
                    batch.commit().then(() => alert("上傳完成！"));
                }
            };

            // Local Auto-Save (Only if NOT in cloud mode)
            useEffect(() => {
                if (isLoaded && !isCloudMode) {
                    localStorage.setItem('cupicho_inventory', JSON.stringify(inventory));
                    localStorage.setItem('cupicho_print_list', JSON.stringify(tags));
                }
            }, [inventory, tags, isLoaded, isCloudMode]);

            // Save Logo Locally (Logo is usually too big for Firestore docs if base64)
            useEffect(() => {
                if (isLoaded && customLogo) {
                    try { localStorage.setItem('cupicho_logo', customLogo); } catch (e) {}
                }
            }, [customLogo, isLoaded]);

            // CRUD Operations (Branching Logic)
            const handleAddInventory = (item) => {
                if (isCloudMode && db) {
                    db.collection('inventory').doc(item.id).set(item);
                } else {
                    setInventory([item, ...inventory]);
                }
            };

            const handleUpdateItem = (id, field, value) => {
                if (isCloudMode && db) {
                    const collectionName = editSource === 'inventory' ? 'inventory' : 'print_list';
                    db.collection(collectionName).doc(id).update({ [field]: value });
                } else {
                    if (editSource === 'inventory') {
                        setInventory(inventory.map(t => t.id === id ? { ...t, [field]: value } : t));
                    } else {
                        setTags(tags.map(t => t.id === id ? { ...t, [field]: value } : t));
                    }
                }
            };

            const handleDeleteItem = (id) => {
                if (isCloudMode && db) {
                    const collectionName = editSource === 'inventory' ? 'inventory' : 'print_list';
                    db.collection(collectionName).doc(id).delete();
                } else {
                    if (editSource === 'inventory') {
                        setInventory(inventory.filter(t => t.id !== id));
                    } else {
                        setTags(tags.filter(t => t.id !== id));
                    }
                }
                setDeleteConfirmId(null);
                if (editingId === id) setEditingId(null);
            };

            const handleAddPrintTag = (item) => {
                const newItem = { ...item, id: Date.now().toString() + Math.random() };
                if (isCloudMode && db) {
                    db.collection('print_list').doc(newItem.id).set(newItem);
                } else {
                    setTags([newItem, ...tags]);
                }
            };

             const handleRemovePrintTag = (itemNo) => {
                // Find latest tag with this itemNo
                const target = tags.find(t => t.itemNo === itemNo);
                if(target) {
                    if(isCloudMode && db) {
                        db.collection('print_list').doc(target.id).delete();
                    } else {
                        const index = tags.findIndex(t => t.id === target.id);
                        const newTags = [...tags];
                        newTags.splice(index, 1);
                        setTags(newTags);
                    }
                }
            };

            const handleClearPrintList = () => {
                if(isCloudMode && db) {
                    // Firestore needs batch delete for all
                    const batch = db.batch();
                    tags.forEach(t => batch.delete(db.collection('print_list').doc(t.id)));
                    batch.commit();
                } else {
                    setTags([]);
                }
                setClearConfirm(false);
            };

            // Other helpers
            const filteredInventory = useMemo(() => {
                if (!searchTerm) return inventory;
                const lowerTerm = searchTerm.toLowerCase();
                return inventory.filter(item => 
                    item.name.toLowerCase().includes(lowerTerm) || 
                    item.itemNo.toLowerCase().includes(lowerTerm) ||
                    (item.engName && item.engName.toLowerCase().includes(lowerTerm))
                );
            }, [inventory, searchTerm]);

            const getPrintCount = (itemNo) => tags.filter(t => t.itemNo === itemNo).length;

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onloadend = () => setCustomLogo(reader.result);
                reader.readAsDataURL(file);
            };

            const addNewToInventory = () => {
                const randomNo = Math.floor(100000 + Math.random() * 900000).toString();
                const newItem = { 
                    id: Date.now().toString(), brand: 'CUPICHO', name: '新商品', engName: '', 
                    weight: '100g', price: '0', country: 'Taiwan', itemNo: randomNo 
                };
                handleAddInventory(newItem);
                setEditingId(newItem.id);
                setEditSource('inventory');
            };

            const handleCSVUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    // Simple CSV Parse logic (same as before)
                    const text = evt.target.result;
                    const rows = text.split(/\r\n|\n/);
                    if(rows.length < 2) return;
                    const newItems = [];
                    // ... parsing logic skipped for brevity, reusing previous logic ...
                    // For demo, re-implementing basic part:
                    for(let i=1; i<rows.length; i++) {
                        const cols = rows[i].split(',');
                        if(cols.length > 2) {
                            newItems.push({
                                id: Date.now().toString() + i,
                                itemNo: cols[0] || '000',
                                brand: cols[1] || 'Brand',
                                name: cols[2] || 'Name',
                                engName: cols[3] || '',
                                price: cols[4] || '0',
                                weight: cols[5] || '',
                                country: cols[6] || ''
                            });
                        }
                    }
                    setCsvImportData(newItems);
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const confirmImport = (mode) => {
                if(!csvImportData) return;
                if(isCloudMode && db) {
                    const batch = db.batch();
                    // Note: Batch limit is 500. For production, chunk it. 
                    // Here we assume small CSV for demo or direct set.
                    csvImportData.forEach(item => {
                         // Overwrite logic for cloud is tricky, usually just set/merge
                         const ref = db.collection('inventory').doc(item.id);
                         batch.set(ref, item);
                    });
                    batch.commit();
                } else {
                    if (mode === 'overwrite') setInventory(csvImportData);
                    else setInventory([...csvImportData, ...inventory]);
                }
                setCsvImportData(null);
                setView('inventory');
            };
            
             const downloadTemplate = () => {
                const csvContent = "\ufeffITEM NO.,BRAND,NAME (CHI),NAME (ENG),PRICE $,WEIGHT,COUNTRY\n2023001,CUPICHO,範例巧克力,,580,55g,Italy\n";
                const link = document.createElement("a");
                link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                link.download = "cupicho_template.csv";
                link.click();
            };


            const PriceTag = ({ tag }) => (
                <div className="cupicho-tag relative flex overflow-hidden box-border" style={{ width: '80mm', height: '50mm', backgroundColor: '#2B130F', color: '#E1C284', fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>
                    <div className="w-[35%] h-full flex flex-col pl-3 py-3 relative z-10">
                        <div className="h-[30%] flex items-start -ml-1">
                            {customLogo ? 
                                <img src={customLogo} className="w-[90%] h-full object-contain object-left-top"/> : 
                                <svg viewBox="0 0 100 45" className="w-[90%] h-auto">
                                    <ellipse cx="50" cy="22.5" rx="48" ry="20" fill="none" stroke="#E1C284" strokeWidth="1.5" />
                                    <ellipse cx="50" cy="22.5" rx="45" ry="17" fill="none" stroke="#E1C284" strokeWidth="0.5" opacity="0.5"/>
                                    <text x="50" y="24" textAnchor="middle" fill="#E1C284" fontSize="16" fontFamily="serif" fontWeight="bold" letterSpacing="0.5">CupiCho</text>
                                    <text x="50" y="36" textAnchor="middle" fill="#E1C284" fontSize="7" fontFamily="sans-serif" letterSpacing="1">丘比巧</text>
                                </svg>
                            }
                        </div>
                        <div className="flex-1 flex items-start pt-2 pl-1">
                            <div className="flex items-baseline" style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>
                                <span style={{ fontSize: '14pt', marginRight: '3px' }}>$</span>
                                <span style={{ fontSize: '20pt', lineHeight: '1' }}>{tag.price}</span>
                            </div>
                        </div>
                        <div className="mt-auto mb-1 w-full pl-1">
                            <div style={{ fontFamily: '"Libre Barcode 39", cursive', fontSize: '40px', color: '#E1C284', lineHeight: 0.7, whiteSpace: 'nowrap', marginLeft: '-10px', transform: 'scaleX(0.9)', transformOrigin: 'left bottom', marginBottom: '2px' }}>
                                {tag.itemNo ? `*${tag.itemNo}*` : ''}
                            </div>
                            <div className="text-[9px] font-serif tracking-widest text-[#E1C284] leading-none">{tag.itemNo}</div>
                        </div>
                    </div>
                    <div className="w-[65%] h-full flex flex-col pr-4 py-3 pl-1 relative z-10">
                        <div style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif', fontSize: '18pt', lineHeight: '1.2', marginBottom: '4px' }}>{tag.brand}</div>
                        <div style={{ fontFamily: '"Kinuta KinutaMincho StdN R", serif', fontSize: '14pt', lineHeight: '1.3', marginBottom: '2px' }}>{tag.name}</div>
                        <div style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif', fontSize: '6pt', lineHeight: '1.2', textTransform: 'uppercase', letterSpacing: '0.5px', opacity: 0.9 }}>{tag.engName}</div>
                        <div className="flex gap-5 absolute bottom-3 right-4" style={{ fontSize: '10pt' }}>
                            <span style={{ fontFamily: '"WenYue GuDianMingChaoTi", serif' }}>{tag.weight}</span>
                            <span style={{ fontFamily: '"Kinuta KinutaMincho StdN R", serif' }}>{tag.country}</span>
                        </div>
                    </div>
                </div>
            );

            const currentEditingTag = editingId ? (editSource === 'inventory' ? inventory.find(t => t.id === editingId) : tags.find(t => t.id === editingId)) : null;

            return (
                <div className="min-h-screen bg-[#1a0e0b] flex flex-col max-w-md mx-auto relative shadow-2xl font-sans text-[#E1C284]">
                    <input type="file" ref={fileInputRef} onChange={handleLogoUpload} accept="image/*" className="hidden" />
                    <input type="file" ref={csvInputRef} onChange={handleCSVUpload} accept=".csv" className="hidden" />

                    <header className="bg-[#2B130F] px-4 py-3 flex items-center justify-between border-b border-[#E1C284]/20 sticky top-0 z-20 shadow-lg no-print">
                        <div className="flex items-center gap-2">
                            <div className="text-[#E1C284]"><Icon name="Palette" size={20}/></div>
                            <div>
                                <div className="flex items-center gap-2">
                                    <h1 className="font-bold text-[#E1C284] text-base tracking-widest">CUPICHO</h1>
                                    <span className="text-[10px] bg-[#E1C284]/20 text-[#E1C284] px-1.5 py-0.5 rounded border border-[#E1C284]/30">{VERSION}</span>
                                </div>
                                <p className={`text-[10px] flex items-center gap-1 ${isCloudMode ? 'text-green-400' : 'text-[#E1C284]/60'}`}>
                                    {isCloudMode ? <><Icon name="Wifi" size={10} /> Cloud Sync</> : <><Icon name="WifiOff" size={10} /> Local Mode</>}
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowDbModal(true)} className={`p-2 rounded-lg border ${isCloudMode ? 'bg-green-900/30 border-green-500 text-green-400' : 'bg-[#2B130F] border-[#E1C284]/50 text-[#E1C284]/50'}`} title="資料庫設定"><Icon name="Database" size={18}/></button>
                            <button onClick={() => fileInputRef.current.click()} className="bg-[#2B130F] border border-[#E1C284]/50 text-[#E1C284] p-2 rounded-lg" title="更換 Logo"><Icon name="Image" size={18}/></button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 pb-28 no-print">
                        {/* 1. 庫存 */}
                        {view === 'inventory' && (
                            <div className="space-y-4">
                                <div className="bg-[#2B130F] p-4 rounded-sm border border-[#E1C284]/30">
                                    <h2 className="font-bold text-lg mb-3 flex items-center gap-2"><Icon name="Database" size={20}/> 商品庫存 ({inventory.length})</h2>
                                    <div className="flex gap-2 mb-3">
                                        <div className="flex-1 relative">
                                            <div className="absolute left-3 top-2.5 text-[#E1C284]/50"><Icon name="Search" size={16}/></div>
                                            <input type="text" placeholder="搜尋..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-3 py-2 bg-[#3e2b27] border border-[#E1C284]/30 rounded-sm text-[#E1C284] outline-none placeholder-[#E1C284]/30"/>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 text-xs">
                                        <button onClick={() => csvInputRef.current.click()} className="flex items-center gap-1 bg-[#E1C284]/20 px-3 py-1.5 rounded-full border border-[#E1C284]/30"><Icon name="FileSpreadsheet" size={12}/> 匯入</button>
                                        <button onClick={downloadTemplate} className="flex items-center gap-1 bg-[#E1C284]/20 px-3 py-1.5 rounded-full border border-[#E1C284]/30"><Icon name="Download" size={12}/> 範本</button>
                                        <button onClick={addNewToInventory} className="flex items-center gap-1 bg-[#E1C284] text-[#2B130F] px-3 py-1.5 rounded-full font-bold ml-auto"><Icon name="Plus" size={12}/> 新增</button>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    {filteredInventory.map(item => {
                                        const count = getPrintCount(item.itemNo);
                                        return (
                                            <div key={item.id} className="bg-[#3e2b27] p-3 rounded-sm border border-[#E1C284]/20 flex justify-between items-center">
                                                <div className="flex-1 min-w-0 pr-2 cursor-pointer" onClick={() => { setEditingId(item.id); setEditSource('inventory'); }}>
                                                    <div className="text-[10px] text-[#E1C284]/60 font-mono">#{item.itemNo}</div>
                                                    <div className="font-bold truncate">{item.name}</div>
                                                    {!item.engName ? (
                                                        <div className="text-[10px] text-red-400/80 italic flex items-center gap-1"><Icon name="AlertCircle" size={10}/> 缺少英文</div>
                                                    ) : (
                                                        <div className="text-[10px] text-[#E1C284]/50 truncate uppercase">{item.engName}</div>
                                                    )}
                                                    <div className="text-xs opacity-70">${item.price}</div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                     <button onClick={() => { setEditingId(item.id); setEditSource('inventory'); }} className="p-2 text-[#E1C284]/50 hover:text-[#E1C284]"><Icon name="Edit3" size={16}/></button>
                                                     {count > 0 ? (
                                                        <div className="flex items-center bg-[#2B130F] border border-[#E1C284] rounded-sm h-8">
                                                            <button onClick={() => handleRemovePrintTag(item.itemNo)} className="px-2 h-full hover:bg-[#E1C284]/20"><Icon name="Minus" size={12}/></button>
                                                            <span className="px-2 text-xs font-bold text-[#E1C284] border-x border-[#E1C284]/30 min-w-[24px] text-center">{count}</span>
                                                            <button onClick={() => handleAddPrintTag(item)} className="px-2 h-full hover:bg-[#E1C284]/20"><Icon name="Plus" size={12}/></button>
                                                        </div>
                                                     ) : (
                                                        <button onClick={() => handleAddPrintTag(item)} className="bg-[#2B130F] border border-[#E1C284] text-[#E1C284] text-xs px-3 py-1.5 rounded-sm flex items-center gap-1"><Icon name="Plus" size={12}/> 加入</button>
                                                     )}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>
                        )}

                        {/* 2. 待印 */}
                        {view === 'list' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center px-1">
                                    <h2 className="font-bold text-lg flex items-center gap-2"><Icon name="List" size={20}/> 待印清單 ({tags.length})</h2>
                                    {tags.length > 0 && <button onClick={() => setClearConfirm(true)} className="text-xs text-red-400 border border-red-400/50 px-2 py-1 rounded-sm flex items-center gap-1"><Icon name="Trash2" size={12}/> 清空</button>}
                                </div>
                                {tags.length === 0 ? <div className="py-20 text-center opacity-50"><p>清單是空的</p><button onClick={() => setView('inventory')} className="text-[#E1C284] underline text-sm mt-2">去庫存挑選</button></div> : 
                                    tags.map(tag => (
                                        <div key={tag.id} className="bg-[#3e2b27] p-4 rounded-sm border border-[#E1C284]/30 shadow-md flex items-center justify-between" onClick={() => { setEditingId(tag.id); setEditSource('list'); }}>
                                            <div className="flex-1 min-w-0 pr-3">
                                                <div className="text-[10px] font-mono text-[#E1C284]/70">#{tag.itemNo}</div>
                                                <p className="font-bold text-[#E1C284] truncate">{tag.name}</p>
                                                {!tag.engName ? (
                                                    <p className="text-[10px] text-red-400/80 italic flex items-center gap-1"><Icon name="AlertCircle" size={10}/> 缺少英文</p>
                                                ) : (
                                                    <p className="text-[10px] text-[#E1C284]/60 truncate uppercase">{tag.engName}</p>
                                                )}
                                            </div>
                                            <div className="flex flex-col items-end gap-1">
                                                <span className="text-xl font-serif text-[#E1C284]">${tag.price}</span>
                                                <button className="p-2 text-[#E1C284]/50 hover:text-red-400" onClick={(e) => { e.stopPropagation(); setDeleteConfirmId(tag.id); setEditSource('list'); }}><Icon name="Trash2" size={16}/></button>
                                            </div>
                                        </div>
                                    ))
                                }
                            </div>
                        )}

                        {/* 3. 預覽 */}
                        {view === 'preview' && (
                            <div className="flex flex-col items-center space-y-6">
                                <div className="w-full flex justify-between items-center px-4 bg-[#E1C284]/10 p-2 rounded-lg border border-[#E1C284]/20">
                                    <span className="text-sm font-bold text-[#E1C284] flex items-center gap-1"><Icon name="Eye" size={16}/> 預覽 ({tags.length})</span>
                                    <button onClick={() => window.print()} className="bg-[#E1C284] text-[#2B130F] px-4 py-1.5 rounded-sm font-bold text-sm flex items-center gap-1"><Icon name="Printer" size={16}/> 列印</button>
                                </div>
                                <div className="w-full flex flex-col items-center gap-6 pb-20">
                                    {tags.map(tag => <div key={tag.id} className="shadow-2xl shadow-black/50"><PriceTag tag={tag} /></div>)}
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="bg-[#2B130F] border-t border-[#E1C284]/20 px-6 py-2 flex justify-around items-center fixed bottom-0 left-0 right-0 max-w-md mx-auto z-30 shadow-2xl pb-safe no-print">
                        <button onClick={() => setView('inventory')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'inventory' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}><Icon name="Database" size={24} /><span className="text-[10px]">庫存</span></button>
                        <div className="w-8"></div>
                        <button onClick={() => setView('list')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'list' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}>
                            <div className="relative"><Icon name="List" size={24} />{tags.length > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full">{tags.length}</span>}</div>
                            <span className="text-[10px]">待印</span>
                        </button>
                        <div className="w-8"></div>
                        <button onClick={() => setView('preview')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${view === 'preview' ? 'text-[#E1C284]' : 'text-[#E1C284]/30'}`}><Icon name="Eye" size={24} /><span className="text-[10px]">預覽</span></button>
                    </nav>

                    {/* Database Settings Modal */}
                    {showDbModal && (
                        <div className="fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl relative">
                                <button onClick={() => setShowDbModal(false)} className="absolute top-2 right-2 text-[#E1C284]/50"><Icon name="X" size={16}/></button>
                                <h3 className="font-serif text-lg text-[#E1C284] text-center mb-4">資料庫設定 (Firebase)</h3>
                                <p className="text-[#E1C284]/60 text-xs mb-2">貼上 Firebase Config JSON 以啟用雲端同步。</p>
                                <textarea 
                                    rows="6"
                                    placeholder='{"apiKey": "AIza...", ...}'
                                    value={firebaseConfigStr}
                                    onChange={(e) => setFirebaseConfigStr(e.target.value)}
                                    className="w-full px-3 py-2 bg-[#1a0e0b] text-[#E1C284] border border-[#E1C284]/30 rounded-sm mb-4 outline-none text-xs font-mono"
                                ></textarea>
                                <button onClick={handleSaveConfig} className="w-full py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold text-sm">儲存並連線</button>
                            </div>
                        </div>
                    )}

                    {/* Editing Drawer */}
                    {editingId && currentEditingTag && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex flex-col justify-end backdrop-blur-[2px]">
                            <div className="bg-[#2B130F] border-t border-[#E1C284]/30 rounded-t-3xl p-6 max-h-[90vh] overflow-y-auto animate-in slide-in-from-bottom duration-300 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-serif text-[#E1C284] flex items-center gap-2 italic">編輯商品</h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => setDeleteConfirmId(editingId)} className="p-2 bg-red-900/30 rounded-full text-red-400"><Icon name="Trash2" size={20}/></button>
                                        <button onClick={() => setEditingId(null)} className="p-2 bg-[#E1C284]/10 rounded-full text-[#E1C284]"><Icon name="X" size={20}/></button>
                                    </div>
                                </div>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="col-span-2 space-y-1"><label className="text-[10px] text-[#E1C284]/60">品號</label><input type="text" value={currentEditingTag.itemNo} onChange={(e) => handleUpdateItem(editingId, 'itemNo', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm border border-[#E1C284]/20"/></div>
                                        <div className="col-span-1 space-y-1"><label className="text-[10px] text-[#E1C284]/60">國家</label><input type="text" value={currentEditingTag.country} onChange={(e) => handleUpdateItem(editingId, 'country', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm border border-[#E1C284]/20 text-center"/></div>
                                    </div>
                                    <div className="space-y-1"><label className="text-[10px] text-[#E1C284]/60">品牌</label><input type="text" value={currentEditingTag.brand} onChange={(e) => handleUpdateItem(editingId, 'brand', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm border border-[#E1C284]/20"/></div>
                                    <div className="space-y-1"><label className="text-[10px] text-[#E1C284]/60">中文品名</label><input type="text" value={currentEditingTag.name} onChange={(e) => handleUpdateItem(editingId, 'name', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm border border-[#E1C284]/20 text-lg"/></div>
                                    <div className="flex gap-2 items-end">
                                        <div className="flex-1 space-y-1"><label className="text-[10px] text-[#E1C284]/60">英文品名</label><input type="text" value={currentEditingTag.engName} onChange={(e) => handleUpdateItem(editingId, 'engName', e.target.value)} className="w-full px-3 py-2 bg-[#1a0e0b] text-[#E1C284] rounded-sm border border-[#E1C284]/20 text-xs uppercase"/></div>
                                        <button onClick={() => window.open(`https://translate.google.com/?sl=zh-TW&tl=en&text=${encodeURIComponent(currentEditingTag.name)}&op=translate`, '_blank')} className="mb-[1px] h-[34px] px-3 bg-blue-100 text-blue-700 border border-blue-200 rounded-sm font-bold text-[10px] flex items-center gap-1"><Icon name="Globe" size={12}/></button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="space-y-1"><label className="text-[10px] text-[#E1C284]/60">價格 $</label><input type="number" value={currentEditingTag.price} onChange={(e) => handleUpdateItem(editingId, 'price', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm border border-[#E1C284]/20 text-2xl"/></div>
                                        <div className="space-y-1"><label className="text-[10px] text-[#E1C284]/60">重量</label><input type="text" value={currentEditingTag.weight} onChange={(e) => handleUpdateItem(editingId, 'weight', e.target.value)} className="w-full px-3 py-3 bg-[#1a0e0b] text-[#E1C284] rounded-sm border border-[#E1C284]/20 text-sm"/></div>
                                    </div>
                                    <button onClick={() => setEditingId(null)} className="w-full py-4 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold flex items-center justify-center gap-2 mt-4"><Icon name="Check" size={20}/> 儲存</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirm */}
                    {deleteConfirmId && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <h3 className="font-serif text-lg mb-2 text-center">確認刪除？</h3>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setDeleteConfirmId(null)} className="flex-1 py-3 bg-[#1a0e0b] text-[#E1C284]/60 rounded-sm border border-[#E1C284]/20">取消</button>
                                    <button onClick={() => handleDeleteItem(deleteConfirmId)} className="flex-1 py-3 bg-[#E1C284] text-[#2B130F] rounded-sm font-bold">刪除</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Clear Confirm */}
                    {clearConfirm && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-[#E1C284] rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <h3 className="font-serif text-lg mb-2 text-center">清空待印清單？</h3>
                                <p className="text-xs text-[#E1C284]/60 text-center mb-6">庫存資料不會受影響。</p>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={() => setClearConfirm(false)} className="flex-1 py-3 bg-[#1a0e0b] text-[#E1C284]/60 rounded-sm border border-[#E1C284]/20">取消</button>
                                    <button onClick={handleClearPrintList} className="flex-1 py-3 bg-red-600 text-white rounded-sm font-bold">確認清空</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Error Msg */}
                    {errorMsg && (
                        <div className="fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-6 backdrop-blur-sm">
                            <div className="bg-[#2B130F] border border-red-500 rounded-sm p-6 w-full max-w-xs shadow-2xl">
                                <div className="flex flex-col items-center"><Icon name="AlertCircle" className="text-red-500 mb-2" size={32}/><p className="text-red-500 text-center font-bold mb-4">{errorMsg}</p><button onClick={() => setErrorMsg(null)} className="w-full py-2 bg-red-500/20 text-red-500 border border-red-500 rounded-sm">關閉</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
